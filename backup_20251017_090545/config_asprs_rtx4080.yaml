# RTX 4080 ULTRA-FAST Configuration - Enriched LAZ ONLY
# ASPRS Processing - GPU Accelerated MAXIMUM SPEED
#
# This configuration is optimized for NVIDIA RTX 4080 Super ULTRA-FAST processing:
# - 16GB GDDR6X VRAM (90% utilization)
# - 16M points GPU batch size
# - NO patch generation (enriched_only mode)
# - Minimal features for maximum speed
# - NO NIR/NDVI fetching (very slow)
# - NO cadastre processing (very slow)
#
# Expected performance: <5 minutes per tile (vs 2+ hours)
#
# Usage:
#   ign-lidar-hd process --config-file configs/config_asprs_rtx4080.yaml
#
# OVERRIDE DEFAULTS TO FORCE OUR PARAMETERS
defaults:
  - override /processor: null
  - override /features: null
  - override /preprocess: null
  - override /stitching: null
  - override /ground_truth: null
  - _self_

# ============================================================================
# I/O PATHS
# ============================================================================
input_dir: /mnt/d/ign/selected_tiles/asprs/tiles
output_dir: /mnt/d/ign/preprocessed/asprs/enriched_tiles
cache_dir: /mnt/d/ign/cache

# ============================================================================
# BOUNDING BOX (Optional)
# ============================================================================
bbox:
  xmin: null
  ymin: null
  xmax: null
  ymax: null

# ============================================================================
# OUTPUT CONFIGURATION (v3.0 Schema)
# ============================================================================
output:
  format: laz
  processing_mode: enriched_only # Direct LAZ enrichment (no patches) - legacy compatibility
  save_stats: true
  save_metadata: false
  compression: null
  skip_existing: false # Process all files for this optimized run

# ============================================================================
# PROCESSOR CONFIGURATION - RTX 4080 OPTIMIZED FOR ENRICHED_ONLY MODE
# ============================================================================
processor:
  lod_level: ASPRS
  processing_mode: enriched_only
  skip_existing: false
  architecture: direct # CHANGED: direct architecture for pure enriched mode (no patches!)

  # GPU Settings - ENHANCED for RTX 4080 Super Maximum Performance
  use_gpu: true
  batch_size: 256 # Increased for better GPU utilization
  prefetch_factor: 4 # Optimized for direct processing
  pin_memory: true # Fast CPU->GPU transfers with pinned memory
  num_workers: 1 # GPU processing requires single worker due to CUDA context limitations

  # Detection modes
  building_detection_mode: asprs
  transport_detection_mode: asprs_extended

  # Patch settings (DISABLED for enriched_only mode)
  generate_patches: false # FORCE disable patch generation
  patch_size: null # Disable patches completely
  patch_overlap: null # Disable patches completely
  num_points: null # Disable patches completely

  # Output - PURE ENRICHED MODE
  output_format: laz
  direct_enrichment: true # Force direct LAZ enrichment
  augment: false
  num_augmentations: 0

  # Tile stitching (disabled for speed)
  use_stitching: false # Disable for faster processing
  buffer_size: 0.0 # No buffer needed

  # Direct enrichment - WITH RECLASSIFICATION
  apply_reclassification_inline: true # Enable inline reclassification for ground truth
  ground_truth_integration_mode: "direct"

  # Enhanced Ground Truth Optimization Settings - AGGRESSIVE
  optimization:
    enabled: true
    level: auto # auto-select best method (gpu_chunked, gpu, strtree, vectorized)
    force_method: null # null for auto-selection, or specify: gpu_chunked, gpu, strtree, vectorized
    enable_monitoring: true # Performance monitoring and auto-tuning
    enable_auto_tuning: true # Automatically optimize parameters
    enable_enhanced_gpu: true # Use enhanced GPU optimizations
    enable_enhanced_cpu: true # Use enhanced CPU optimizations
    benchmark_on_first_run: false # Set to true for comprehensive benchmarking

  # Reclassification - ENABLED for Ground Truth Classification
  reclassification:
    enabled: true # ENABLED - for ground truth reclassification
    acceleration_mode: cpu # CPU mode for stability
    chunk_size: 2_000_000 # Medium chunks for stability
    gpu_chunk_size: 2_000_000 # Medium GPU chunks
    show_progress: true
    skip_existing: false

    # Basic optimization settings - RELIABLE
    use_enhanced_optimization: false # Keep simple for stability
    adaptive_chunk_sizing: true # Allow adaptive sizing
    memory_pool_enabled: false # Disable to avoid GPU errors
    enable_cuda_graphs: false # Disable advanced features
    vram_utilization_target: 0.7 # Conservative VRAM usage
    enable_async_transfers: false
    num_cuda_streams: 1

    # Geometric rules - ENABLED for better classification
    use_geometric_rules: true # Enable for ground truth classification
    ndvi_vegetation_threshold: 0.3
    ndvi_road_threshold: 0.15
    road_vegetation_height_threshold: 2.0
    building_buffer_distance: 2.0
    max_building_height_difference: 3.0
    verticality_threshold: 0.7
    verticality_search_radius: 1.0
    min_vertical_neighbors: 5

# ============================================================================
# PROCESSING CONFIGURATION - PURE ENRICHED_ONLY MODE
# ============================================================================
processing:
  # Classification target
  lod_level: "ASPRS" # Options: ASPRS, LOD2, LOD3

  # Processing mode - FORCE ENRICHED ONLY
  mode: "enriched_only" # STRICT: only enriched LAZ output, NO PATCHES!

  # Target architecture - DIRECT for pure enrichment
  architecture: "direct" # CHANGED: direct processing for pure LAZ enrichment

  # Performance
  num_workers: 1 # GPU processing limitation
  use_gpu: true # Enable GPU acceleration

  # Patch extraction - COMPLETELY DISABLED
  generate_patches: false # FORCE disable patch generation
  patch_size: null # Disabled
  patch_overlap: null # Disabled
  num_points: null # Disabled

  # Augmentation (disabled for speed)
  augment: false
  num_augmentations: 0

# ============================================================================
# FEATURES CONFIGURATION - ULTRA-FAST GPU OPTIMIZED
# ============================================================================
features:
  mode: asprs_classes # Lightweight ~15 features for ASPRS

  # GPU Settings - OPTIMIZED FOR STABILITY RTX 4080
  use_gpu: true
  gpu_batch_size: 8_000_000 # REDUCED: 4M points per GPU batch for stability (avoid fallback)
  use_gpu_chunked: true # Enable chunked processing for very large tiles
  adaptive_chunk_sizing: true # Dynamic chunk size optimization
  vram_utilization_target: 0.85 # CONSERVATIVE: Use 75% of available VRAM for stability
  enable_async_processing: true # Asynchronous GPU processing
  num_cuda_streams: 6 # REDUCED: Fewer streams for stability
  memory_pool_enabled: true # Reuse GPU memory allocations

  # Neighbor search - BALANCED settings for GPU stability
  k_neighbors: 12 # BALANCED: Good quality vs speed tradeoff
  search_radius: 0.8 # BALANCED: Good quality vs speed tradeoff
  include_extra: false

  # Core geometric features - MINIMAL SET FOR SPEED
  compute_normals: true # Essential for classification
  compute_planarity: true # Essential for roads/buildings
  compute_curvature: false # Disabled for speed
  compute_linearity: false # Disabled for speed
  compute_verticality: false # DISABLED for speed (not critical for ASPRS)
  compute_height_above_ground: true # Essential for vegetation height
  compute_horizontality: false # DISABLED for speed
  compute_sphericity: false # DISABLED for speed

  # Spectral features - MINIMAL SET
  use_rgb: true
  use_infrared: false # DISABLED: NIR fetching is very slow
  use_nir: false # DISABLED: NIR fetching is very slow
  compute_ndvi: false # DISABLED: Requires NIR which is slow to fetch
  augment_rgb: false
  augment_infrared: false

  # Advanced features (all disabled for maximum speed)
  compute_architectural_features: false
  include_architectural_style: false
  compute_wall_likelihood: false
  compute_roof_likelihood: false
  compute_surface_variation: false
  compute_anisotropy: false
  compute_eigenvalue_features: false
  compute_local_point_density: false
  compute_roughness: false
  compute_moment_features: false
  compute_multiscale_features: false
  compute_normal_variation: false
  compute_normal_change_rate: false

  # Sampling and normalization
  sampling_method: fps # Farthest point sampling
  normalize_xyz: true
  normalize_features: true

  # GPU optimization settings - STABLE PERFORMANCE
  gpu_optimization:
    enabled: true
    adaptive_memory_management: true
    enable_memory_pooling: true
    enable_tensor_cores: true
    enable_mixed_precision: false # DISABLED: Can cause fallback issues on some systems
    enable_kernel_fusion: true

  # CPU optimization settings (minimal fallback)
  cpu_optimization:
    enabled: false # DISABLED: Focus purely on GPU processing
    enable_numba_acceleration: false
    enable_parallel_processing: false
    enable_vectorization: false
    enable_spatial_indexing: false
    max_workers: 1

# ============================================================================
# PREPROCESSING - MINIMAL FOR SPEED
# ============================================================================
preprocess:
  enabled: false # DISABLED: Skip all preprocessing for maximum speed

  # Statistical Outlier Removal (disabled)
  sor_enabled: false
  sor_k: 10
  sor_std: 2.0

  # Radius Outlier Removal (disabled)
  ror_enabled: false
  ror_radius: 1.0
  ror_neighbors: 5

  # Voxel downsampling (disabled)
  voxel_enabled: false
  voxel_size: 0.1

# ============================================================================
# TILE STITCHING - DISABLED FOR SPEED
# ============================================================================
stitching:
  enabled: false # DISABLED: Skip stitching for maximum processing speed
  buffer_size: 0.0
  auto_detect_neighbors: false
  auto_download_neighbors: false
  cache_enabled: false
  cache_dir: ${cache_dir}/neighbors

# ============================================================================
# GROUND TRUTH CONFIGURATION - SIMPLIFIED FOR SPEED
# ============================================================================
ground_truth:
  enabled: true
  update_classification: true
  use_ndvi: true # DISABLED: NDVI computation is very slow (fetches NIR)
  fetch_rgb_nir: true # DISABLED: RGB/NIR fetching is extremely slow
  apply_reclassification: true # ENABLED: Apply ground truth reclassification
  cache_dir: ${cache_dir}/ground_truth # Simplified optimization settings
  optimization:
    enabled: true
    auto_select_method: true # Let system choose fastest method
    force_method: "auto" # AUTO selection - GPU when available, CPU fallback
    enable_monitoring: false # Disable monitoring for speed
    enable_auto_tuning: false # Disable auto-tuning for speed

    # Conservative GPU settings (fallback only)
    gpu_chunk_size: 1_000_000 # Conservative chunk size
    adaptive_chunk_sizing: false
    enable_memory_pooling: false
    enable_cuspatial: false # Disable to avoid GPU errors

    # CPU optimization settings - RELIABLE
    enable_rtree_indexing: true # Fast spatial indexing
    enable_numba_acceleration: true # JIT compilation for speed
    enable_parallel_processing: true # Multi-threaded processing

    # Performance settings
    verbose: false # Minimal logging for speed
    benchmark_on_first_run: false
    cache_optimization_results: true

# ============================================================================
# ENHANCED DATA SOURCES - BD TOPO & CADASTRE WITH OPTIMIZATION (v3.0 Schema)
# ============================================================================
data_sources:
  # BD TOPO® V3 - MINIMAL FEATURES FOR SPEED
  bd_topo_enabled: true
  bd_topo_buildings: true # ASPRS 6 - Essential
  bd_topo_roads: true # ASPRS 11 - Essential
  bd_topo_water: true # ASPRS 9 - Essential
  bd_topo_vegetation: false # ASPRS 5 - DISABLED for speed
  bd_topo_cache_dir: ${cache_dir}/bd_topo

  # BD Forêt (disabled for ASPRS-focused processing)
  bd_foret_enabled: false
  bd_foret_cache_dir: ${cache_dir}/bd_foret

  # RPG - Agriculture (disabled for ASPRS-focused processing)
  rpg_enabled: false
  rpg_year: 2024
  rpg_cache_dir: ${cache_dir}/rpg

  # BD PARCELLAIRE - Cadastre DISABLED FOR SPEED
  cadastre_enabled: false # DISABLED: Very slow processing
  cadastre_cache_dir: ${cache_dir}/cadastre

  # Simplified BD TOPO processing - ESSENTIAL FEATURES ONLY
  bd_topo:
    enabled: true
    cache_enabled: true

    # Features to fetch - MINIMAL SET FOR SPEED
    features:
      buildings: true # ASPRS 6 - Essential
      roads: true # ASPRS 11 - Essential
      railways: false # ASPRS 10 - Disabled for speed
      water: true # ASPRS 9 - Essential
      vegetation: false # ASPRS 5 - Disabled (slow to process)
      bridges: true # ASPRS 17 - Disabled for speed
      parking: true # ASPRS 40 - Disabled for speed
      cemeteries: true # ASPRS 42 - Disabled for speed
      power_lines: true # ASPRS 43 - Disabled for speed
      sports: true # ASPRS 41 - Disabled for speed

    # Enhanced geometry generation parameters
    parameters:
      road_width_fallback: 4.0
      road_buffer_tolerance: 0.5
      railway_width_fallback: 3.5
      railway_buffer_tolerance: 0.6
      power_line_buffer: 2.0

      # Height filtering (exclude bridges/overpasses)
      road_height_max: 1.5
      road_height_min: -0.3
      rail_height_max: 1.2
      rail_height_min: -0.2

      # Enhanced geometric filtering
      road_planarity_min: 0.6
      rail_planarity_min: 0.5

      # Enhanced intensity filtering
      enable_intensity_filter: true
      road_intensity_min: 0.15
      road_intensity_max: 0.7
      rail_intensity_min: 0.1
      rail_intensity_max: 0.8

    # Enhanced caching and optimization
    cache_dir: ${cache_dir}/bd_topo
    use_cache: true
    enable_spatial_indexing: true # Pre-build spatial indices for faster queries
    enable_geometry_simplification: true # Simplify complex geometries for speed
    optimization_level: high # high, medium, low

  # BD PARCELLAIRE - Cadastre COMPLETELY DISABLED
  cadastre:
    enabled: false # FORCE DISABLED: Cadastre processing is very slow
    group_by_parcel: false
    label_parcel_id: false
    compute_statistics: false
    export_parcel_stats: false
    export_attributes: false
    cache_dir: ${cache_dir}/cadastre
    use_cache: false # DISABLED

    # All optimization disabled
    enable_spatial_indexing: false
    optimization_level: disabled
    enable_geometry_simplification: false

  # BD Forêt (disabled for ASPRS-focused processing)
  bd_foret:
    enabled: false

  # RPG - Agriculture (disabled for ASPRS-focused processing)
  rpg:
    enabled: false

# ============================================================================
# ENHANCED CLASSIFICATION SETTINGS
# ============================================================================
classification:
  enabled: true

  # Classification methods - GROUND TRUTH FOCUSED
  methods:
    ground_truth: true # PRIMARY: Use BD TOPO ground truth
    geometric: true # SECONDARY: Geometric rules for unclassified points
    ndvi: false # DISABLED: No NIR fetching for speed
    forest_types: false
    crop_types: false

  # Priority order (lowest to highest - last wins)
  priority_order:
    - vegetation # 3/4/5
    - water # 9
    - cemeteries # 42
    - parking # 40
    - sports # 41
    - power_lines # 43
    - railways # 10
    - roads # 11
    - bridges # 17
    - buildings # 6 (highest priority)

  # Enhanced thresholds with optimization hints
  thresholds:
    ndvi_vegetation: 0.35
    ndvi_building: 0.15
    height_low_veg: 0.5
    height_medium_veg: 2.0
    planarity_road: 0.8
    planarity_building: 0.7
    road_buffer_tolerance: 0.5
    building_buffer_tolerance: 0.0
    use_building_footprints: true
    ground_truth_building_priority: high

  # Enhanced post-processing with optimization
  post_processing:
    enabled: true
    reclassify_unclassified: true
    use_enhanced_algorithms: true # Use enhanced classification algorithms
    enable_parallel_processing: true # Parallel post-processing
    optimization_level: high # high, medium, low

# ============================================================================
# PERFORMANCE MONITORING AND OPTIMIZATION (Enhanced v3.0)
# ============================================================================
performance:
  monitoring:
    enabled: true # Enable performance monitoring
    log_level: INFO # DEBUG, INFO, WARNING, ERROR
    save_metrics: true # Save performance metrics to file
    metrics_file: performance_metrics.json
    enable_gpu_profiling: true # Profile GPU utilization

  optimization:
    auto_tuning: true # Automatically tune parameters based on performance
    cache_optimizations: true # Cache optimization results
    adaptive_batch_sizing: true # Adapt batch sizes based on GPU memory
    memory_optimization: high # high, medium, low
    enable_memory_monitoring: true # Monitor memory usage patterns
    enable_thermal_monitoring: false # Monitor GPU temperatures (experimental)

  reporting:
    generate_summary: true # Generate performance summary report
    summary_file: performance_summary.txt
    include_gpu_metrics: true # Include GPU utilization metrics
    include_timing_breakdown: true # Detailed timing analysis
    save_optimization_logs: true # Save optimization decision logs

# ============================================================================
# GLOBAL SETTINGS (v3.0 Schema Compatibility)
# ============================================================================
# Global logging and verbosity
verbose: true
log_level: "INFO" # DEBUG, INFO, WARNING, ERROR

# Global worker settings (compatibility)
num_workers: 1 # Overridden by processor.num_workers for GPU processing
# ============================================================================
# ENHANCED PERFORMANCE NOTES FOR RTX 4080 SUPER (Updated October 2025)
# ============================================================================
# Expected performance with v3.0 enhanced optimizations:
# - Feature computation: ~10-50x faster than CPU (was 5-10x in v2.x)
# - Ground truth computation: ~10-1000x faster than CPU (was 8-12x in v2.x)
# - Reclassification: ~15-25x faster than CPU (was 8-12x in v2.x)
# - Overall speedup: ~10-50x vs CPU-only (was 5-10x in v2.x)
# - Memory usage: ~8-12GB VRAM (out of 16GB available)
# - Processing time: ~10-30 seconds per tile (was 30-60 seconds in v2.x)
#
# v3.0 Enhanced optimization features:
# 1. Automatic hardware detection and method selection
# 2. GPU memory pooling and adaptive chunk sizing
# 3. Enhanced spatial indexing for CPU fallback
# 4. Performance monitoring and auto-tuning
# 5. Intelligent method switching based on data characteristics
# 6. v3.0 schema compatibility with backward compatibility
# 7. Improved memory management and garbage collection
# 8. Enhanced GPU profiling and thermal monitoring
#
# Tips for maximum performance:
# 1. Close other GPU applications (browsers, games, etc.)
# 2. Monitor with: watch -n 1 nvidia-smi
# 3. Check optimization logs for method selection
# 4. If OOM errors occur:
#    - Reduce features.gpu_batch_size to 1_000_000
#    - Reduce processor.batch_size to 32
#    - Reduce reclassification.gpu_chunk_size to 3_000_000
# 5. For very large tiles (>100M points):
#    - Enhanced chunked processing automatically handles this
#    - Monitor GPU memory usage during processing
# 6. Enable benchmarking on first run for optimal settings:
#    - Set processor.optimization.benchmark_on_first_run: true
# 7. v3.0 optimizations include:
#    - Automatic fallback to CPU if GPU memory insufficient
#    - Intelligent pre-filtering to reduce computational load
#    - Advanced memory management and garbage collection
#    - Schema validation and migration support
# 8. Configuration compatibility:
#    - Both v2.x (processor/features) and v3.0 (processing/features) schemas supported
#    - Automatic parameter migration where needed
#    - Enhanced validation and error reporting
