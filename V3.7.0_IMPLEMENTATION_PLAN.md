# v3.7.0 Transitional Release - Implementation Plan

**Purpose:** Final v3.x release with enhanced warnings before v4.0.0  
**Timeline:** Mid-January 2026  
**Branch:** v3.7.0-prep (from main)  
**Status:** Ready to implement

---

## ðŸŽ¯ Objectives

1. **Warn Users:** Comprehensive deprecation warnings for all v4.0 changes
2. **Provide Tools:** Migration tooling readily available
3. **Document Changes:** Clear migration guides
4. **Smooth Transition:** 3-6 month buffer before v4.0

---

## ðŸ“‹ Implementation Checklist

### Phase A: Branch Setup (Week 1)

#### Create v3.7.0 Branch
```bash
# From main branch
git checkout main
git pull origin main
git checkout -b v3.7.0-prep
```

#### Update Version Numbers
```bash
python scripts/bump_version.py 3.7.0 --type minor
```

Files to update:
- [ ] `pyproject.toml` â†’ version = "3.7.0"
- [ ] `ign_lidar/__init__.py` â†’ __version__ = "3.7.0"
- [ ] `docs/docusaurus.config.ts` â†’ version: "3.7.0"
- [ ] `CHANGELOG.md` â†’ Add v3.7.0 section

---

### Phase B: Enhanced Deprecation Warnings (Week 1-2)

#### 1. Configuration Warnings

**File:** `ign_lidar/config/schema.py` (lines 1-70)

âœ… **ALREADY DONE** - Good warnings in place. Just need to update version refs:
- Update "Q1 2026" â†’ "Mid-2026 (v4.0)"
- Ensure migration tool command is correct
- Add link to V4_BREAKING_CHANGES.md

**File:** `ign_lidar/config/config.py` (lines 120-130)

Current warnings need enhancement:
```python
# ENHANCE THIS
if 'processor' in kwargs:
    warnings.warn(
        "The 'processor' parameter will be removed in v4.0.",
        DeprecationWarning,
        stacklevel=2
    )
```

Should be:
```python
if 'processor' in kwargs:
    warnings.warn(
        "\n" + "="*80 + "\n"
        "âš ï¸  DEPRECATION WARNING - Config v3.x Structure âš ï¸\n\n"
        "Nested 'processor' parameter is deprecated and will be REMOVED in v4.0.0\n\n"
        "MIGRATION:\n"
        "  # OLD (v3.x - deprecated):\n"
        "  config = Config(processor={'lod_level': 'LOD2', 'use_gpu': True})\n\n"
        "  # NEW (v4.0 - required):\n"
        "  config = Config(mode='lod2', use_gpu=True)\n"
        "  # Or use presets:\n"
        "  config = Config.preset('lod2_buildings')\n\n"
        "Automatic migration:\n"
        "  $ ign-lidar migrate-config your_config.yaml\n\n"
        "Timeline: v4.0.0 release in Q2 2026\n"
        "See: V4_BREAKING_CHANGES.md\n"
        + "="*80,
        DeprecationWarning,
        stacklevel=2
    )
```

#### 2. FeatureComputer Warnings

**File:** `ign_lidar/features/feature_computer.py`

Current warning (lines 31-37) is good but needs timeline update:

```python
# Current
warnings.warn(
    "The 'FeatureComputer' class is deprecated as of v3.7.0 and will be removed in v4.0.0. "
    "Use 'FeatureOrchestrator' instead.",
    DeprecationWarning,
    stacklevel=2
)

# ENHANCE TO:
warnings.warn(
    "\n" + "="*80 + "\n"
    "âš ï¸  DEPRECATION WARNING - FeatureComputer Class âš ï¸\n\n"
    "FeatureComputer is deprecated and will be REMOVED in v4.0.0 (Q2 2026)\n\n"
    "MIGRATION:\n"
    "  # OLD (deprecated):\n"
    "  from ign_lidar.features import FeatureComputer\n"
    "  computer = FeatureComputer(use_gpu=True)\n"
    "  features = computer.compute_features(points)\n\n"
    "  # NEW (required in v4.0):\n"
    "  from ign_lidar.features import FeatureOrchestrator\n"
    "  from ign_lidar import Config\n"
    "  config = Config(use_gpu=True)\n"
    "  orchestrator = FeatureOrchestrator(config)\n"
    "  features = orchestrator.compute_features(points)\n\n"
    "Benefits: Better performance, cleaner API, more features\n"
    "See: V4_BREAKING_CHANGES.md section 2\n"
    + "="*80,
    DeprecationWarning,
    stacklevel=2
)
```

#### 3. Deprecated Normal Function Warnings

**File:** `ign_lidar/features/numba_accelerated.py`

Add warnings to these functions (currently no warnings):
- `compute_normals_from_eigenvectors()`
- `compute_normals_from_eigenvectors_numpy()`
- `compute_normals_from_eigenvectors_numba()`

```python
def compute_normals_from_eigenvectors(eigenvectors: np.ndarray) -> np.ndarray:
    """
    DEPRECATED: Will be removed in v4.0.0
    
    Use ign_lidar.features.compute.normals.compute_normals() instead.
    """
    warnings.warn(
        "\n" + "="*80 + "\n"
        "âš ï¸  DEPRECATION WARNING - compute_normals_from_eigenvectors() âš ï¸\n\n"
        "This function will be REMOVED in v4.0.0 (Q2 2026)\n\n"
        "MIGRATION:\n"
        "  # OLD (deprecated):\n"
        "  from ign_lidar.features.numba_accelerated import compute_normals_from_eigenvectors\n"
        "  normals = compute_normals_from_eigenvectors(eigenvectors)\n\n"
        "  # NEW (required in v4.0):\n"
        "  from ign_lidar.features.compute.normals import compute_normals\n"
        "  normals = compute_normals(points, k_neighbors=30)\n\n"
        "The new API computes eigenvalues internally for better performance.\n"
        "See: V4_BREAKING_CHANGES.md section 3\n"
        + "="*80,
        DeprecationWarning,
        stacklevel=2
    )
    # ... existing implementation
```

#### 4. GPU API Warnings

**File:** `ign_lidar/optimization/gpu_wrapper.py`

Add warning to `check_gpu_available()` (if it exists):

```python
def check_gpu_available() -> bool:
    """
    DEPRECATED: Will be removed in v4.0.0
    
    Use GPUManager.gpu_available instead.
    """
    warnings.warn(
        "\n" + "="*80 + "\n"
        "âš ï¸  DEPRECATION WARNING - check_gpu_available() âš ï¸\n\n"
        "This function will be REMOVED in v4.0.0 (Q2 2026)\n\n"
        "MIGRATION:\n"
        "  # OLD (deprecated):\n"
        "  from ign_lidar.optimization.gpu_wrapper import check_gpu_available\n"
        "  if check_gpu_available():\n"
        "      ...\n\n"
        "  # NEW (required in v4.0):\n"
        "  from ign_lidar.core.gpu import GPUManager\n"
        "  gpu = GPUManager()\n"
        "  if gpu.gpu_available:\n"
        "      ...\n\n"
        "Benefits: Centralized GPU management, better error handling\n"
        "See: V4_BREAKING_CHANGES.md section 5\n"
        + "="*80,
        DeprecationWarning,
        stacklevel=2
    )
    # ... existing implementation
```

#### 5. Legacy Import Warnings

**File:** `ign_lidar/features/__init__.py`

Enhance existing warning (around line 338):

```python
# Current warning is good, just add timeline
warnings.warn(
    f"Importing from 'ign_lidar.features.core' is deprecated. "
    f"Import '{name}' from 'ign_lidar.features.compute' instead.\n"
    f"The 'features.core' path will be removed in v4.0.0 (Q2 2026).\n"
    f"See: V4_BREAKING_CHANGES.md section 4",
    DeprecationWarning,
    stacklevel=2
)
```

---

### Phase C: Documentation Updates (Week 2)

#### Update CHANGELOG.md

Add comprehensive v3.7.0 entry:

```markdown
## [3.7.0] - 2026-01-15 - Final v3.x Release ðŸš¨

**This is the FINAL v3.x release before v4.0.0 (breaking changes)**

### Purpose

v3.7.0 is a **transitional release** designed to prepare users for v4.0.0:
- Enhanced deprecation warnings for all breaking changes
- Migration tooling readily available
- 3-6 month buffer before v4.0.0
- Full backward compatibility maintained

### Enhanced Deprecation Warnings âš ï¸

All code that will be removed in v4.0.0 now shows comprehensive warnings:

1. **Configuration v3.x Structure**
   - Nested `processor` parameter deprecated
   - Migration: Use flat structure or presets
   - Tool: `ign-lidar migrate-config`

2. **FeatureComputer Class**
   - Deprecated in favor of FeatureOrchestrator
   - Better performance and API

3. **Deprecated Normal Functions**
   - `compute_normals_from_eigenvectors()` and variants
   - Migration: Use canonical `compute_normals()` API

4. **Legacy Import Paths**
   - `ign_lidar.features.core` â†’ `ign_lidar.features.compute`

5. **GPU Helper Functions**
   - `check_gpu_available()` deprecated
   - Migration: Use `GPUManager.gpu_available`

### Migration Support

- âœ… Automatic config migration: `ign-lidar migrate-config`
- âœ… Comprehensive migration guide: V4_BREAKING_CHANGES.md
- âœ… Side-by-side code examples
- âœ… Common issues and solutions

### Timeline

- **v3.7.0 (Jan 2026)**: Final v3.x with warnings
- **v3.7.x (Q1-Q2 2026)**: Patch releases if needed
- **v4.0.0 (Q2 2026)**: Breaking changes, deprecated code removed
- **v3.x EOL**: Q3 2026

### Upgrade Path

1. **Upgrade to v3.7.0** (this release)
2. **Address warnings** - Run your code and note deprecation warnings
3. **Migrate config** - Run `ign-lidar migrate-config`
4. **Update code** - Follow migration examples
5. **Test thoroughly** - Ensure everything works
6. **Upgrade to v4.0** - When ready (Q2 2026)

### Added

- Enhanced deprecation warnings (comprehensive, actionable)
- v4.0 migration documentation
- Breaking changes reference guide
- Timeline information in all warnings

### No Functional Changes

All functionality remains identical to v3.6.3. This release only adds warnings.

### Support

- Questions: GitHub Discussions
- Issues: GitHub Issues
- Email: simon.ducournau@gmail.com
- Docs: https://sducournau.github.io/IGN_LIDAR_HD_DATASET/
```

#### Create Migration Announcement

**File:** `docs/docs/announcements/v3.7.0-transition.md`

```markdown
# v3.7.0 Transitional Release - Preparing for v4.0

**Release Date:** January 15, 2026  
**Type:** Final v3.x Release  
**Purpose:** Smooth transition to v4.0.0

## What is v3.7.0?

v3.7.0 is the **final v3.x release** before v4.0.0. It's designed to help you prepare
for the upcoming breaking changes with:

- ðŸš¨ Enhanced deprecation warnings
- ðŸ”§ Migration tooling
- ðŸ“š Comprehensive guides
- â° 3-6 month transition period

## Why Upgrade to v3.7.0 Now?

1. **Get Early Warning** - See what will break in v4.0
2. **Use Migration Tools** - Automatic config migration
3. **Plan Your Upgrade** - Know what code changes are needed
4. **Stay Supported** - v3.6.x support ends with v4.0 release

## What's Changing in v4.0?

See [V4_BREAKING_CHANGES.md](../V4_BREAKING_CHANGES.md) for complete details.

## How to Upgrade

### Step 1: Upgrade to v3.7.0
```bash
pip install --upgrade ign-lidar-hd==3.7.0
```

### Step 2: Run Your Code
```bash
python your_script.py
# Watch for deprecation warnings
```

### Step 3: Migrate Config
```bash
ign-lidar migrate-config your_config.yaml
```

### Step 4: Update Code
Follow the warnings and use our migration guide.

### Step 5: Test
Ensure everything works before v4.0 drops.

## Timeline

- âœ… **Now (v3.7.0)**: Warnings active, tools available
- ðŸ”„ **Q1-Q2 2026**: Transition period
- ðŸš€ **Q2 2026**: v4.0.0 release
- âŒ **Q3 2026**: v3.x EOL

## Need Help?

- Migration Guide: [V4_BREAKING_CHANGES.md](../V4_BREAKING_CHANGES.md)
- GitHub Issues: Report problems
- Discussions: Ask questions
- Email: simon.ducournau@gmail.com
```

---

### Phase D: Testing (Week 3)

#### Test All Warnings Fire

Create test script: `scripts/test_v3_7_warnings.py`

```python
#!/usr/bin/env python3
"""Test that all v3.7.0 deprecation warnings fire correctly"""

import warnings
import sys

def test_config_warning():
    """Test config v3.x structure warning"""
    with warnings.catch_warnings(record=True) as w:
        warnings.simplefilter("always")
        from ign_lidar import Config
        # This should trigger warning
        config = Config(processor={'lod_level': 'LOD2'})
        assert len(w) > 0
        assert "processor" in str(w[0].message).lower()
        print("âœ… Config v3.x warning fires")

def test_feature_computer_warning():
    """Test FeatureComputer deprecation warning"""
    with warnings.catch_warnings(record=True) as w:
        warnings.simplefilter("always")
        from ign_lidar.features import FeatureComputer
        assert len(w) > 0
        assert "featurecomputer" in str(w[0].message).lower()
        print("âœ… FeatureComputer warning fires")

def test_normal_function_warning():
    """Test deprecated normal function warning"""
    with warnings.catch_warnings(record=True) as w:
        warnings.simplefilter("always")
        from ign_lidar.features.numba_accelerated import compute_normals_from_eigenvectors
        import numpy as np
        eigenvectors = np.random.rand(100, 3, 3)
        normals = compute_normals_from_eigenvectors(eigenvectors)
        assert len(w) > 0
        print("âœ… Normal function warning fires")

def test_legacy_import_warning():
    """Test legacy import path warning"""
    with warnings.catch_warnings(record=True) as w:
        warnings.simplefilter("always")
        # This should trigger warning if old path used
        # from ign_lidar.features.core import compute_normals
        print("âœ… Legacy import warning fires")

if __name__ == '__main__':
    print("Testing v3.7.0 Deprecation Warnings...\n")
    
    try:
        test_config_warning()
        test_feature_computer_warning()
        test_normal_function_warning()
        test_legacy_import_warning()
        print("\nâœ… All warnings working correctly!")
        sys.exit(0)
    except Exception as e:
        print(f"\nâŒ Test failed: {e}")
        sys.exit(1)
```

#### Run Full Test Suite

```bash
# All tests must pass
pytest tests/ -v

# Ensure warnings don't break tests
pytest tests/ -v -W default

# Test coverage
pytest tests/ -v --cov=ign_lidar --cov-report=html
```

---

### Phase E: Release (Week 4)

#### Pre-Release Checklist

- [ ] All version numbers updated
- [ ] CHANGELOG.md complete
- [ ] All warnings tested
- [ ] All tests passing
- [ ] Documentation updated
- [ ] Migration guide accessible
- [ ] Examples tested

#### Release Steps

```bash
# 1. Final commit
git add -A
git commit -m "chore: Prepare v3.7.0 release (final v3.x)"

# 2. Merge to main
git checkout main
git merge v3.7.0-prep

# 3. Tag release
git tag -a v3.7.0 -m "v3.7.0 - Final v3.x release with v4.0 transition support"

# 4. Push
git push origin main
git push origin v3.7.0

# 5. Build distribution
python -m build

# 6. Upload to PyPI
python -m twine upload dist/*

# 7. Create GitHub release
gh release create v3.7.0 \
  --title "v3.7.0 - Final v3.x Release (v4.0 Transition)" \
  --notes-file RELEASE_NOTES_3.7.0.md
```

#### Post-Release

- [ ] Announce on GitHub Discussions
- [ ] Blog post
- [ ] Social media
- [ ] Email mailing list
- [ ] Update documentation website

---

## ðŸ“Š Success Metrics

- [ ] All deprecated code shows warnings
- [ ] Warnings are actionable (clear migration steps)
- [ ] Migration tool works for >95% of configs
- [ ] All tests pass
- [ ] Zero functional regressions
- [ ] Community feedback collected

---

## ðŸŽ¯ Timeline

- **Week 1** (Dec 9-15): Branch setup, version bump, warning enhancements
- **Week 2** (Dec 16-22): Documentation, more warnings
- **Week 3** (Dec 23-Jan 5): Testing, bug fixes (holiday break)
- **Week 4** (Jan 6-12): Final testing, release prep
- **Jan 15, 2026**: v3.7.0 RELEASE

---

## ðŸ“ž Notes

- v3.7.0 is **identical in functionality** to v3.6.3
- Only adds **warnings** and **documentation**
- No new features, no bug fixes (unless critical)
- Purpose is **purely transitional**

---

**Status:** Ready to implement  
**Next:** Create v3.7.0-prep branch and begin
