---
sidebar_position: 0
title: Version 1.7.6
description: Critical Verticality Fix & Feature Verification System
---

# Version 1.7.6 - Critical Fix & Verification

**Release Date**: October 6, 2025  
**Type**: Bug Fix & Feature Release

---

## üêõ Critical Bug Fix: Verticality Computation

### Issue

Files processed with `--use-gpu` on large point clouds (>5 million points) had a critical bug where the **verticality feature contained all zeros** instead of real values.

### Impact

- ‚ùå **Wall detection broken** - verticality is essential for identifying vertical surfaces
- ‚ùå **Building segmentation degraded** - unable to separate walls from roofs/ground
- ‚ùå **Wasted disk space** - 4 additional features with all zeros (`eigenvalue_sum`, `omnivariance`, `eigenentropy`, `surface_variation`)
- ‚ùå **15-20% larger files** - unnecessary zero-value features

### Root Cause

The GPU chunked processing code (`features_gpu_chunked.py`) initialized the verticality feature but never computed it. Additionally, it initialized 4 extra eigenvalue-based features that were never calculated, resulting in files bloated with useless zero-value data.

### Fix

**1. Added Verticality Computation** (lines 1033-1040 in `features_gpu_chunked.py`):

```python
# Compute verticality from normals (for wall detection)
chunk_normals_for_vert = normals[start_idx:end_idx]
verticality_chunk = gpu_computer.compute_verticality(chunk_normals_for_vert)
if 'verticality' not in geo_features:
    geo_features['verticality'] = np.zeros(N, dtype=np.float32)
geo_features['verticality'][start_idx:end_idx] = verticality_chunk
```

**2. Removed Uncomputed Features** (line 908):

- Removed: `eigenvalue_sum`, `omnivariance`, `eigenentropy`, `surface_variation`
- Kept only: features that are actually computed

**3. Fixed All Code Paths**:

- ‚úÖ GPU chunked processing (>5M points with `--use-gpu`)
- ‚úÖ Simple GPU processing (<5M points with `--use-gpu`)
- ‚úÖ CPU processing (all modes)

### Results

**Before Fix:**

- Verticality: all 0.0 (unusable)
- File size: +15-20% (zero-value bloat)
- Wall detection: failed

**After Fix:**

- ‚úÖ Verticality: real values (0-1 range)
- ‚úÖ File size: 15-20% smaller
- ‚úÖ Wall detection: working correctly
- ‚úÖ No wasted disk space

### Verification

To check if your files have the bug:

```python
import laspy
import numpy as np

las = laspy.read('your_file.laz')

# Check verticality
if hasattr(las, 'verticality'):
    vert = las.verticality
    if vert.std() < 1e-6:
        print("‚ùå BUG: Verticality is all zeros!")
    else:
        print(f"‚úÖ Verticality working: {vert.min():.4f} - {vert.max():.4f}")
```

### Re-processing Recommendation

If you have files processed with v1.7.0-1.7.5 using `--use-gpu` on large files (>5M points), we recommend re-processing them:

```bash
ign-lidar-hd enrich \
  --input /path/to/raw_tiles/ \
  --output /path/to/enriched_fixed/ \
  --mode full \
  --k-neighbors 30 \
  --add-rgb --rgb-cache-dir /path/to/rgb_cache \
  --add-infrared --infrared-cache-dir /path/to/nir_cache \
  --preprocess \
  --use-gpu \
  --force
```

---

## ‚ú® New Feature: Verification System

### Overview

New comprehensive feature verification system to validate enriched LAZ files and detect data quality issues.

### CLI Command

```bash
# Verify all files in a directory
ign-lidar-hd verify --input-dir /path/to/enriched/

# Verify specific file
ign-lidar-hd verify --input /path/to/file.laz

# Quick mode (no samples)
ign-lidar-hd verify --input-dir /path/to/enriched/ --quiet

# Show sample point values
ign-lidar-hd verify --input /path/to/file.laz --show-samples

# Limit number of files
ign-lidar-hd verify --input-dir /path/to/enriched/ --max-files 10
```

### Features Checked

The verification system validates:

**1. RGB Values**

- ‚úì Presence check
- ‚úì Value ranges (0-255)
- ‚úì Unique color combinations
- ‚ö†Ô∏è Default gray value detection (128,128,128)

**2. NIR (Infrared)**

- ‚úì Presence check
- ‚úì Value distribution
- ‚úì Unique values count
- ‚ö†Ô∏è Default value detection

**3. Geometric Features**

- ‚úì Linearity (0-1 range)
- ‚úì Planarity (0-1 range)
- ‚úì Sphericity (0-1 range)
- ‚úì Anisotropy (0-1 range)
- ‚úì Roughness (0-1 range)
- ‚ö†Ô∏è Zero-value detection
- ‚ö†Ô∏è No variation detection

**4. Building Features**

- ‚úì Wall score
- ‚úì Roof score
- ‚úì Verticality (0-1 range)
- ‚úì Height above ground

### Python API

```python
from ign_lidar.verifier import verify_laz_files

# Verify directory
verify_laz_files(
    input_dir="/path/to/enriched/",
    max_files=5,
    verbose=True,
    show_samples=True
)
```

### Output Example

```
================================================================================
Analyzing: LHD_FXX_0889_6252_PTS_C_LAMB93_IGN69.laz
================================================================================
Total points: 5,143,421

1. RGB VALUES CHECK
--------------------------------------------------------------------------------
‚úì RGB channels present
  Red:   min= 11, max=255, mean=175.06, std= 42.08
  Green: min= 15, max=255, mean=171.17, std= 41.38
  Blue:  min= 18, max=255, mean=165.52, std= 38.04
  Unique RGB combinations: 80,747
  ‚úì RGB values look good

2. NIR (INFRARED) VALUES CHECK
--------------------------------------------------------------------------------
‚úì NIR channel present
  Range: 0 - 239
  Mean: 138.61, Std: 41.00
  Unique NIR values: 236
  ‚úì NIR values look good

3. LINEARITY CHECK
--------------------------------------------------------------------------------
‚úì Linearity present
  Range: 0.000000 - 0.996009
  Mean: 0.715198, Std: 0.254567
  Non-zero count: 5,143,421 (100.00%)
  ‚úì Linearity values in valid range [0, 1]

4. OTHER GEOMETRIC FEATURES CHECK
--------------------------------------------------------------------------------
‚úì planarity    : min=0.0000, max=0.4999, mean=0.1321, non-zero=100.0%
‚úì sphericity   : min=0.0000, max=0.3078, mean=0.0067, non-zero=99.9%
‚úì anisotropy   : min=0.0000, max=1.0000, mean=0.9895, non-zero=100.0%
‚úì verticality  : min=0.0001, max=0.9981, mean=0.4235, non-zero=100.0%
```

---

## üì¶ Files Modified

### Core Fixes

- `ign_lidar/features_gpu_chunked.py` - Verticality computation added, zero-value features removed
- `ign_lidar/features.py` - Verticality added to simple GPU and CPU paths

### New Files

- `ign_lidar/verifier.py` - Feature verification module
- `tests/test_verticality_fix.py` - Verticality computation tests
- `tests/test_all_verticality_paths.py` - Comprehensive code path tests

### Documentation

- `FEATURE_VERIFICATION_FIX.md` - Root cause analysis
- `VERTICALITY_IMPLEMENTATION.md` - Implementation details
- `CHANGELOG.md` - Updated with fix details
- `README.md` - Updated with v1.7.6 highlights

---

## üß™ Testing

### Verticality Tests

```bash
# Run verticality fix tests
python tests/test_verticality_fix.py

# Test all code paths
python tests/test_all_verticality_paths.py
```

### Expected Results

```
‚úÖ ALL TESTS PASSED
‚úì CPU version - Verticality working
‚úì Simple GPU version - Verticality working
‚úì GPU chunked version - Verticality working
```

---

## üìä Performance Impact

- **Computation time**: +0.5% (negligible - verticality is very fast)
- **Memory usage**: No change
- **File size**: **-15 to -20%** (removed zero-value features)
- **Data quality**: ‚úÖ Wall detection now working correctly

---

## üîÑ Migration Guide

### For Affected Users

If you processed files with v1.7.0-1.7.5 using `--use-gpu` on files >5M points:

1. **Check your files**:

   ```bash
   ign-lidar-hd verify --input-dir /path/to/enriched/
   ```

2. **Re-process if needed**:

   ```bash
   ign-lidar-hd enrich --input raw/ --output fixed/ --use-gpu --force
   ```

3. **Verify the fix**:
   ```bash
   ign-lidar-hd verify --input-dir /path/to/fixed/
   ```

### For New Users

No action needed! Just use v1.7.6 and you'll get correct results.

---

## üìö Resources

- **Bug Report**: `FEATURE_VERIFICATION_FIX.md`
- **Implementation**: `VERTICALITY_IMPLEMENTATION.md`
- **Tests**: `tests/test_verticality_fix.py`, `tests/test_all_verticality_paths.py`
- **Changelog**: [CHANGELOG.md](../../CHANGELOG.md)

---

## üôè Acknowledgments

Thanks to the user who reported the verticality issue, enabling this critical fix!

---

## Next Steps

1. Install or upgrade to v1.7.6:

   ```bash
   pip install --upgrade ign-lidar-hd
   ```

2. Verify your existing files:

   ```bash
   ign-lidar-hd verify --input-dir /your/enriched/files/
   ```

3. Re-process if needed with the fix applied

For questions or issues, please open a GitHub issue.
