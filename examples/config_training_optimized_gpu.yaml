# ============================================================================
# IGN LiDAR HD - GPU-Optimized Training with Ground Truth
# ============================================================================
# Optimized for RTX 3060 (12GB VRAM) with BD Topo ground truth
# Includes roads, buildings, vegetation, water from IGN WFS
# GPU-accelerated feature computation and ground truth labeling
# ============================================================================

config_version: "6.3.0"
preset_name: "gpu_optimized_training"

# ============================================================================
# PROCESSOR - GPU OPTIMIZED
# ============================================================================
processor:
  lod_level: "LOD2"
  architecture: "hybrid"
  processing_mode: "both"
  output_format: "laz"

  # GPU Configuration - OPTIMIZED FOR RTX 3060 (12GB)
  use_gpu: true
  gpu_device: 0
  gpu_batch_size: 2_000_000 # 2M points per batch (optimal for 12GB VRAM)
  gpu_memory_target: 0.75 # Use 75% of VRAM (9GB)
  vram_limit_gb: 9.0 # Conservative limit for stable operation

  # No multiprocessing with GPU (CUDA context issues)
  num_workers: 0

  # Patches
  patch_size: 50.0
  num_points: 32000
  overlap: 0.10 # Reduced overlap

  sampling_method: "random" # Faster than fps

  # Reduce augmentations for speed
  augment: true
  num_augmentations: 3 # Reduced from 5

  batch_size: "auto"
  prefetch_factor: 2
  pin_memory: true

# ============================================================================
# PREPROCESSING - MINIMAL
# ============================================================================
preprocess:
  enabled: false # Disable for speed (data already clean)

# ============================================================================
# STITCHING - DISABLED FOR SPEED
# ============================================================================
stitching:
  enabled: false # Disable stitching to avoid loading neighbors

# ============================================================================
# FEATURES - SINGLE SCALE FOR GPU SPEED
# ============================================================================
features:
  mode: "lod2"
  k_neighbors: 20 # Reduced for GPU speed
  search_radius: 2.0 # Reduced radius

  # Core features only
  compute_normals: true
  compute_curvature: true
  compute_height: true
  compute_geometric: true
  compute_density: true
  compute_anisotropy: false # Disable for speed

  # RGB
  use_rgb: true
  compute_ndvi: false # Disable (needs NIR fetch)
  use_infrared: false
  use_nir: false

  # Height
  height_method: "local"
  compute_height_above_ground: true
  compute_height_local: true

  # DISABLE MULTI-SCALE FOR GPU SPEED
  multi_scale_computation: false

  # RGB augmentation
  rgb_augmentation:
    enabled: false # Disable orthophoto fetch (use LAZ RGB only)

  # Feature normalization
  normalize_xyz: true
  normalize_features: true
  normalize_method: "z_score"

  # FORCE GPU STRATEGY FOR FEATURES
  gpu_batch_size: 2_000_000 # 2M points per feature batch
  use_gpu_chunked: true # Force chunked GPU strategy
  force_gpu: true # Force GPU even for large point clouds

# ============================================================================
# DATA SOURCES - OPTIMIZED FOR GPU TRAINING
# ============================================================================
data_sources:
  rge_alti:
    enabled: false # Disable DTM augmentation for speed

# ============================================================================
# GROUND TRUTH - BD TOPO WITH ROADS ENABLED
# ============================================================================
# GPU-accelerated ground truth labeling with BD Topo WFS integration
# Provides accurate labels for roads, buildings, vegetation, water
# Uses parallel fetching and GPU-optimized spatial indexing
ground_truth:
  enabled: true # Enable ground truth classification

  # Processing method - GPU optimized (100-1000x faster)
  method: "auto" # Auto-select GPU if available (GPU_CHUNKED for large datasets)
  chunk_size: 2_000_000 # 2M points per chunk (matches GPU batch size)

  # Caching - ESSENTIAL for speed
  cache_dir: null # Auto-set to {input_dir}/cache/ground_truth
  cache_ttl_days: 30 # Cache validity
  cache_compression: true # Compress cached files

  # Processing options
  preclassify: true # Pre-classify for better results
  show_progress: true # Show progress

  # BD TOPO configuration
  bd_topo:
    enabled: true

    # Feature layers - ROADS ENABLED
    features:
      buildings:
        enabled: true # Buildings for training context

      roads:
        enabled: true # ENABLE ROADS for ground truth
        buffer_distance: 1.0 # 1m buffer for alignment

      vegetation:
        enabled: true # Vegetation for context

      water:
        enabled: true # Water bodies

      railways:
        enabled: false # Disable for speed (optional)

      bridges:
        enabled: false # Disable (not in BDTOPO_V3)

      power_lines:
        enabled: false # Disable for speed (optional)

    # Parameters
    parameters:
      road_width_fallback: 4.0 # Default road width (meters)
      use_spatial_index: true # Fast spatial queries (STRtree)

    # Performance
    cache_enabled: true # CRITICAL - cache WFS responses

# ============================================================================
# CLASSIFICATION - BASIC
# ============================================================================
classification:
  mode: "lod2"
  normalize_classes: true

  height_classification:
    enabled: true
    low_vegetation_max: 0.5
    medium_vegetation_max: 2.0
    high_vegetation_min: 2.0

# ============================================================================
# RECLASSIFICATION - DISABLED
# ============================================================================
reclassification:
  enabled: false

# ============================================================================
# OUTPUT - NPZ + LAZ
# ============================================================================
output:
  format: "laz"

  enriched_laz:
    enabled: true
    output_dir: "enriched_tiles"
    compression: true

  patches:
    enabled: true
    format: "npz"
    output_dir: "patches"
    save_laz: false # Disable LAZ patches to save disk I/O

  output_structure: "flat"
  patch_naming: "coordinates"

  # Minimal extra dims
  extra_dims:
    - planarity
    - verticality
    - horizontality
    - curvature
    - height
    - height_above_ground
    - point_density
    - intensity

  save_classification: true
  save_confidence_scores: false
  include_metadata: true
  metadata_format: "json"

# ============================================================================
# MONITORING
# ============================================================================
monitoring:
  enabled: true
  log_level: "INFO"
  track_memory: true
  track_gpu_usage: true
  track_processing_time: true
  progress_interval: 1

# ============================================================================
# CACHE - WRITE TO C: DRIVE FOR SPEED
# ============================================================================
cache:
  enabled: true
  cache_dir: "/mnt/c/Users/Simon/ign_lidar/training_patches_50m_32k/cache" # Fast SSD cache

  # Cache ground truth (WFS responses are expensive to refetch)
  cache_features: true # Cache computed features
  cache_ground_truth: true # IMPORTANT: Cache BD Topo WFS responses
  cache_rgb: false # Disable RGB cache (not used)
  cache_kdtrees: true # Cache KD-trees for faster neighbor searches

# ============================================================================
# VALIDATION - MINIMAL
# ============================================================================
validation:
  enabled: true
  check_point_density: false
  check_patch_completeness: true
  min_points_per_patch: 30000
  reject_incomplete_patches: true
  check_nan_values: true
