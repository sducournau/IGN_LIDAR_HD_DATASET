# ============================================================================
# IGN LiDAR HD - ASPRS Multi-Scale Artifact-Free + Facade Enhanced v6.3.3 CPU
# ============================================================================
# MULTI-SCALE ARTIFACT-FREE + FACADE ENHANCED VERSION - CPU OPTIMIZED
# For systems with moderate RAM (32-40GB) requiring superior facade detection
# and artifact-free features - CPU PROCESSING MODE
#
# Based on v6.3.3 GPU version with CPU OPTIMIZATIONS:
#
# üî• CPU OPTIMIZATIONS:
# 1. DISABLED GPU: use_gpu = false
# 2. PARALLEL PROCESSING: 8 CPU workers (adjust based on cores)
# 3. LARGER CHUNKS: 5M points per chunk (vs 2M for GPU)
# 4. OPTIMIZED BATCH PROCESSING: Efficient CPU memory usage
# 5. NO GPU MONITORING: Disabled GPU usage tracking
#
# üî• MULTI-SCALE ARTIFACT REDUCTION (unchanged):
# 1. THREE SCALES: Fine (1.0m/20nn), Medium (2.5m/50nn), Coarse (5.0m/100nn)
# 2. VARIANCE-WEIGHTED AGGREGATION: Down-weights noisy scales automatically
# 3. ARTIFACT DETECTION: Identifies and suppresses artifact-prone points
# 4. 50-75% REDUCTION in scan line and edge artifacts
# 5. CLEANER FEATURES: Smoother normals, better planarity, more stable geometry
#
# üè¢ FACADE ENHANCEMENT (unchanged):
# 1. LARGER LATERAL BUFFERS: 1.5-12.0m (was 1.0-8.5m) for deep facades/courtyards
# 2. MORE PERMISSIVE VERTICALITY: 0.45-0.50 (was 0.55-0.65) for textured/semi-vertical walls
# 3. ENHANCED GAP DETECTION: 96 resolution (was 72), 4.0m band (was 2.5m)
# 4. LOWER HEIGHT THRESHOLDS: 1.5m (was 2.0m) to catch low walls/annexes
# 5. STRICTER NDVI FILTERING: max 0.18-0.20 (was 0.25) to exclude vegetation
# 6. AGGRESSIVE EXPANSION: 3.5m search radius (was 2.0m) for missing facades
#
# EXPECTED MEMORY FOOTPRINT (CPU):
# - Peak: ~28-35GB (same as GPU version)
# - Processing: ~22-28GB average
# - Safe for 32GB+ RAM systems
#
# PERFORMANCE EXPECTATIONS (CPU vs GPU):
# - Feature computation: ~20-30 min per tile (vs ~6-9 min GPU)
# - Classification: ~3-5 min per tile (vs ~2-3 min GPU)
# - Total: ~30-45 min per tile (vs ~15-20 min GPU)
# - ~2-3x slower than GPU but no VRAM requirements
#
# CPU CONFIGURATION RECOMMENDATIONS:
# - num_workers: Set to 75-85% of available CPU cores
#   * 8-core CPU: num_workers = 6-8
#   * 12-core CPU: num_workers = 10-12
#   * 16-core CPU: num_workers = 12-14
# - chunk_size: 5M points is optimal for most CPUs
#   * If <32GB RAM: reduce to 3-4M
#   * If >64GB RAM: increase to 8-10M
# ============================================================================

config_version: "6.3.3-cpu"
preset_name: "asprs_memory_optimized_facade_enhanced_cpu"

# ============================================================================
# PROCESSOR CONFIGURATION - CPU OPTIMIZED
# ============================================================================
processor:
  lod_level: "ASPRS"
  processing_mode: "both"
  output_format: "laz"

  # Performance - CPU MODE
  use_gpu: false # CPU processing

  # üî• CPU-OPTIMIZED CHUNKING for memory management
  chunk_size: 5_000_000 # INCREASED for CPU efficiency (was 2M for GPU)

  # Parallel processing - CPU MODE
  num_workers: 1 # Utilize CPU cores (adjust based on available cores)

  # Patch generation
  patch_size: 50.0
  num_points: 24576
  overlap: 0.1

# ============================================================================
# PREPROCESSING CONFIGURATION
# ============================================================================
preprocess:
  enabled: true
  sor_k: 12
  sor_std: 2.0
  ror_radius: 1.0
  ror_neighbors: 4
  voxel_enabled: false
  voxel_size: 0.1

# ============================================================================
# STITCHING CONFIGURATION
# ============================================================================
stitching:
  enabled: false
  buffer_size: 10.0
  auto_detect_neighbors: true
  auto_download_neighbors: false
  cache_enabled: true

# ============================================================================
# FEATURES CONFIGURATION - SINGLE SCALE (MEMORY OPTIMIZED)
# ============================================================================
features:
  mode: "asprs_classes"

  # Geometric computation
  k_neighbors: 30
  search_radius: 3.0

  # Core features
  compute_normals: true
  compute_curvature: true
  compute_height: true
  compute_geometric: true
  compute_density: true

  # Cluster IDs
  compute_cluster_id: true
  compute_building_cluster_id: true
  compute_parcel_cluster_id: true

  # Spectral features
  compute_ndvi: true
  use_rgb: true
  use_infrared: true

  # Height computation
  height_method: "dtm"
  use_rge_alti_for_height: true
  compute_height_above_ground: true
  compute_height_local: true

  # RGB/NIR augmentation
  rgb_augmentation:
    enabled: true
    method: "orthophoto"
    resolution: 0.2
    cache_enabled: true

  nir_augmentation:
    enabled: true
    method: "irc"
    resolution: 0.5
    cache_enabled: true

# ============================================================================
# DATA SOURCES CONFIGURATION
# ============================================================================
data_sources:
  rge_alti:
    enabled: true
    use_wcs: true
    resolution: 1.0
    cache_enabled: true
    cache_dir: null
    cache_ttl_days: 90
    prefer_lidar_hd: true
    api_key: "pratique"

  bd_topo:
    enabled: true
    features:
      buildings: true
      roads: true
      water: true
      vegetation: true
      railways: true
      bridges: false
    wfs_url: "https://data.geopf.fr/wfs"
    max_features: 10000
    timeout: 30
    cache_enabled: true
    cache_dir: null
    use_global_cache: false

  cadastre_enabled: true
  bd_foret_enabled: false
  rpg_enabled: false
  orthophoto_rgb: true
  orthophoto_nir: true

ground_truth:
  enabled: true
  method: "auto"
  chunk_size: 5_000_000 # CPU-OPTIMIZED: Larger chunks (was 2M for GPU)

  # Caching
  cache_dir: null
  cache_ttl_days: 30
  cache_compression: true

  # Processing options
  preclassify: true
  show_progress: true

  # üî• REDUCED DTM AUGMENTATION for memory
  rge_alti:
    augment_ground: true
    augmentation_strategy: "gaps" # CHANGED from "intelligent" to "gaps" (less memory)
    augmentation_spacing: 1.0
    min_distance_to_existing: 0.5
    max_elevation_difference: 6.0

    # Priority areas (simplified for "gaps" strategy)
    augmentation_priority:
      vegetation: true # DISABLED for "gaps" strategy
      buildings: true # DISABLED for "gaps" strategy
      gaps: true
      water: true
      roads: true

    # Validation (less strict for memory)
    validate_against_neighbors: true
    min_neighbors_for_validation: 3 # REDUCED from 4 to 3
    neighbor_search_radius: 10.0 # REDUCED from 12m to 10m

    # Classification
    synthetic_ground_class: 2
    mark_as_synthetic: true

    # üéØ IMPROVED HEIGHT COMPUTATION for classification
    use_for_height_computation: true # NEW: Use RGE ALTI for height_above_ground
    height_computation_resolution: 1.0 # NEW: 1m resolution for accurate heights
    cache_height_grids: true # NEW: Cache computed height grids

  # BD TOPO configuration (same as asprs_complete.yaml)
  bd_topo:
    enabled: true
    path: "./data/ground_truth/BDTOPO/"
    assign_building_cluster_ids: true
    assign_parcel_cluster_ids: true

    cadastre:
      enabled: true
      path: "./data/ground_truth/cadastre/"
      parcel_file: "PARCELLE.shp"

    features:
      buildings:
        enabled: true
        file: "BATIMENT.shp"

        # üè¢ ENHANCED BUILDING DETECTION PARAMETERS
        buffer_distance: 4 # üî• INCREASED: Larger base buffer for better facade capture (was 1.0)
        use_extended_classes: true
        extrude_3d: true
        height_field: "hauteur"
        height_fallback: 6.0
        height_min: 2.0 # üî• LOWERED: Catch low buildings/annexes (was 2.5)
        height_max: 200.0

        # üéØ ADAPTIVE BUFFER - CRITICAL FOR FACADES
        enable_adaptive_buffer: true
        adaptive_buffer_min: 1.5 # üî• INCREASED: Larger min for missing facades (was 1.0)
        adaptive_buffer_max: 12.0 # üî• INCREASED: Much larger max for deep facades/courtyards (was 8.5)

        # üß± WALL/FACADE DETECTION - ENHANCED FOR MISSING FACADES
        wall_verticality_threshold: 0.50 # üî• LOWERED: Catch semi-vertical facades (was 0.60)
        missing_wall_threshold: 0.12 # üî• LOWERED: More aggressive expansion (was 0.15)
        vertical_buffer: 1.2 # üî• INCREASED: Larger vertical tolerance (was 0.8)
        horizontal_buffer_ground: 2.5 # üî• INCREASED: Much larger ground buffer for missing walls (was 1.5)
        horizontal_buffer_upper: 3.5 # üî• INCREASED: Much larger upper buffer for balconies/overhangs (was 2.0)

        # üèóÔ∏è ADVANCED FACADE DETECTION
        detect_setbacks: true
        detect_overhangs: true
        enable_3d_hull_expansion: true
        overhang_max_distance: 9.0 # üî• INCREASED: Even larger overhang detection (was 7.0)
        roof_horizontal_expansion: 5.0 # üî• INCREASED: Larger roof expansion for facades (was 4.0)

        # üî∫ ALPHA SHAPE for complex facades
        enable_alpha_shape: true
        alpha_value: 3.5 # üî• INCREASED: More aggressive shape detection for missing facades (was 2.5)

        # üß± WALL-SPECIFIC DETECTION - CRITICAL FOR FACADES
        wall_detection_enabled: true
        min_wall_height: 1.5 # üî• LOWERED: Catch low walls/annexes (was 2.0)
        max_wall_thickness: 1.5 # üî• INCREASED: Thicker walls for better capture (was 1.0)
        wall_normal_tolerance: 0.30 # üî• RELAXED: Allow more variation in wall normals (was 0.20)

        # üè¢ FLOOR SEGMENTATION
        enable_floor_segmentation: true
        floor_height: 3.0
        min_floor_points: 100

        # üîç GAP DETECTION (for facades) - ENHANCED
        enable_gap_detection: true
        gap_detection_resolution: 96 # üî• INCREASED: Even higher resolution for missing facades (was 72)
        gap_detection_band_width: 4.0 # üî• INCREASED: Much wider band to search further (was 2.5)
        gap_min_points_per_sector: 8 # üî• LOWERED: More sensitive to sparse facades (was 10)
        gap_significant_threshold: 0.08 # üî• LOWERED: More aggressive gap detection (was 0.12)

      roads:
        enabled: true
        file: "TRONCON_DE_ROUTE.shp"

        # üõ£Ô∏è ROAD DETECTION - ENHANCED TO AVOID HIGH POINTS
        buffer_distance: 1.5 # IMPROVED: Larger buffer (was 1.2)
        classification_method: "surface_type"

        # Width-based classification
        use_width_field: true
        width_field: "largeur"
        width_field_alt: "largeur_de_chaussee"
        width_fallback: 4.5
        width_min: 2.0
        width_max: 50.0
        width_multiplier: 0.65 # IMPROVED: Slightly larger (was 0.6)

        # üéØ HEIGHT-BASED FILTERING (NEW)
        enable_height_filtering: true
        max_height_above_ground: 0.5 # CRITICAL: Only near-ground points
        exclude_elevated_points: true # Exclude trees, buildings above roads
        min_height_above_ground: -0.5 # Allow slight depressions

        # üå≥ VEGETATION EXCLUSION (NEW)
        exclude_vegetation: true
        max_ndvi_for_road: 0.15 # Exclude vegetated areas

        # üè¢ BUILDING EXCLUSION (NEW)
        exclude_buildings: true
        min_distance_to_building: 0.5 # Keep away from building edges

        # üåâ BRIDGE DETECTION (NEW)
        detect_bridges: true
        bridge_height_threshold: 2.0 # Points above this = bridge
        bridge_planarity_min: 0.75 # Bridges are planar

      vegetation:
        enabled: true
        files: ["ZONE_DE_VEGETATION.shp", "HAIE.shp"]
        height_based_classification: true
        buffer_distance: 0.3

      water:
        enabled: true
        files: ["SURFACE_HYDROGRAPHIQUE.shp", "COURS_D_EAU.shp"]
        buffer_distance: 2.5

      railways:
        enabled: true
        file: "TRONCON_DE_VOIE_FERREE.shp"

      bridges:
        enabled: true
        file: "PONT.shp"

    use_extended_classes: true
    cache_enabled: true
    use_spatial_index: true

# ============================================================================
# CLASSIFICATION CONFIGURATION - PRECISION ENHANCED
# ============================================================================
classification:
  mode: "asprs"
  normalize_classes: true
  strict_normalization: false

  height_classification:
    enabled: true
    low_vegetation_max: 0.5
    medium_vegetation_max: 2.0
    high_vegetation_min: 2.0

  ndvi_classification:
    enabled: true
    vegetation_threshold: 0.3
    strong_vegetation_threshold: 0.5

  thresholds:
    ground:
      max_height_above_ground: 0.25 # IMPROVED: More strict (was 0.3)
      min_planarity: 0.88 # IMPROVED: Higher planarity (was 0.85)
      min_horizontality: 0.85 # IMPROVED: More horizontal (was 0.8)

    # üéØ ROAD THRESHOLDS - CRITICAL IMPROVEMENTS
    roads:
      # Height: STRICT filtering to avoid elevated points (trees, buildings, bridges)
      min_height_above_ground: -0.5 # Allow slight depressions
      max_height_above_ground: 0.5 # STRICT: Only near-ground points (was 0.5, but now enforced)
      max_height_above_ground_strict: 0.3 # Extra strict mode for urban areas

      # Geometric: Roads are very planar and smooth
      min_planarity: 0.80 # IMPROVED: Higher planarity (was 0.75)
      min_planarity_strict: 0.85 # Extra strict for clean roads
      max_roughness: 0.04 # IMPROVED: Smoother surfaces (was 0.05)
      max_curvature: 0.05 # NEW: Exclude complex curved surfaces

      # Vegetation exclusion
      max_ndvi: 0.15 # IMPROVED: Exclude vegetation (was not set)
      max_verticality: 0.25 # NEW: Exclude vertical structures (walls, trees)

      # Horizontal orientation
      min_horizontality: 0.90 # NEW: Roads are horizontal

    # üè¢ BUILDING THRESHOLDS - ENHANCED FACADE DETECTION
    buildings:
      # Height requirements
      min_height: 1.5 # üî• LOWERED: Catch low walls/annexes/facades (was 2.0)
      min_height_strict: 2.5 # Extra strict for urban buildings
      max_height: 150.0 # Reasonable maximum building height

      # Wall/facade detection - CRITICAL FOR FACADES
      min_verticality: 0.45 # üî• LOWERED: Catch semi-vertical facades (was 0.55)
      min_verticality_strict: 0.60 # üî• LOWERED: Less strict for textured walls (was 0.70)
      min_wall_verticality: 0.65 # üî• LOWERED: Walls can be less vertical (was 0.75)
      max_wall_planarity: 0.50 # üî• INCREASED: Allow less planar textured walls (was 0.40)
      min_wall_points: 50 # üî• LOWERED: Require fewer points for sparse facades (was 75)
      wall_to_roof_ratio: 0.25 # üî• LOWERED: Adjust balance for missing facades (was 0.35)

      # Roof detection
      min_roof_planarity: 0.70 # IMPROVED: Higher planarity (was 0.65)
      min_roof_planarity_strict: 0.80 # Extra strict for flat roofs
      max_roof_curvature: 0.12 # IMPROVED: Less curvature allowed (was 0.15)
      max_roof_verticality: 0.30 # NEW: Roofs should not be vertical

      # Facade-specific thresholds - CRITICAL IMPROVEMENTS
      facade_detection_enabled: true # NEW: Enable dedicated facade detection
      min_facade_height: 1.5 # üî• LOWERED: Catch low facades (was 2.5)
      min_facade_verticality: 0.50 # üî• LOWERED: More permissive for textured facades (was 0.65)
      facade_thickness_max: 1.2 # üî• INCREASED: Allow thicker walls (was 0.8)
      facade_continuity_min: 0.5 # üî• LOWERED: Less strict for broken facades (was 0.7)

      # Building context - NDVI FILTERING
      max_ndvi: 0.20 # üî• LOWERED: Stricter vegetation exclusion (was 0.25)
      building_buffer_expansion: 1.5 # üî• INCREASED: Expand polygons more (was 1.2)

    vegetation:
      min_ndvi: 0.3
      max_planarity: 0.6
      max_verticality: 0.4
      min_height_high_veg: 2.0 # NEW: Minimum for high vegetation

    water:
      min_height_above_ground: -0.5
      max_height_above_ground: 0.25 # IMPROVED: Tighter range (was 0.3)
      min_planarity: 0.85 # IMPROVED: Higher planarity (was 0.80)
      max_ndvi: 0.15 # IMPROVED: Lower NDVI (was 0.2)

    # üåâ BRIDGE/ELEVATED STRUCTURE THRESHOLDS
    bridges:
      enabled: true # NEW: Enable bridge detection
      min_height_above_ground: 2.0 # Minimum height for bridges
      max_height_above_ground: 15.0 # Maximum reasonable bridge height
      min_planarity: 0.75 # Bridge decks are planar
      min_horizontality: 0.85 # Bridges are horizontal
      require_road_alignment: true # Must align with road network

# ============================================================================
# RECLASSIFICATION - ENHANCED PRECISION
# ============================================================================
reclassification:
  enabled: true
  use_geometric_rules: true
  use_ndvi_classification: true
  use_spectral_rules: true
  use_clustering: true

  # üéØ ENHANCED THRESHOLDS for better precision
  ndvi_vegetation_threshold: 0.35 # IMPROVED: Higher threshold (was 0.3)
  ndvi_road_threshold: 0.12 # IMPROVED: Lower for roads (was 0.15)
  ndvi_building_max: 0.18 # üî• NEW: Maximum NDVI for buildings (strict vegetation exclusion)
  nir_vegetation_threshold: 0.45 # IMPROVED: Higher for vegetation (was 0.4)
  nir_building_threshold: 0.25 # IMPROVED: Lower for buildings (was 0.3)

  # Clustering parameters
  spatial_cluster_eps: 0.5
  min_cluster_size: 10

  # Confidence thresholds
  min_classification_confidence: 0.35 # üî• LOWERED: Accept more uncertain facades (was 0.40)
  rejection_confidence_threshold: 0.25 # üî• INCREASED: Be less aggressive in rejection (was 0.20)

  # üî• NEW: Height-based reclassification rules
  height_based_refinement:
    enabled: true

    # Elevated points cannot be roads (except bridges)
    reclassify_elevated_roads:
      enabled: true
      max_road_height: 0.5 # Points above this cannot be roads
      min_bridge_height: 2.0 # Points above this are bridges
      check_bridge_alignment: true

    # High points with NDVI are vegetation
    reclassify_high_ndvi_to_vegetation:
      enabled: true
      min_height: 1.5 # Above this height
      min_ndvi: 0.30 # With this NDVI = vegetation

    # Vertical points near buildings are facades - ENHANCED
    reclassify_vertical_to_building:
      enabled: true
      min_verticality: 0.50 # üî• LOWERED: Catch semi-vertical facades (was 0.65)
      max_distance_to_building: 3.5 # üî• INCREASED: Search further from polygons (was 2.0)
      min_height: 1.5 # üî• LOWERED: Catch low facades (was 2.0)
      max_ndvi: 0.20 # üî• NEW: Exclude vegetation from building classification

  # üî• NEW: Conflict resolution priorities
  class_priority_order:
    # Higher priority = resolved first
    - water # Priority 1: Water bodies are most certain
    - buildings # Priority 2: Buildings (solid structures)
    - bridges # Priority 3: Bridges (elevated roads)
    - roads # Priority 4: Roads (ground level)
    - vegetation # Priority 5: Vegetation (fills gaps)
    - ground # Priority 6: Ground (default)

  # üî• NEW: Post-processing filters
  post_processing:
    enabled: true

    # Remove isolated misclassifications
    remove_isolated_points:
      enabled: true
      min_cluster_size: 5
      apply_to_classes: ["roads", "buildings", "water"]

    # Smooth class boundaries
    smooth_boundaries:
      enabled: true
      kernel_size: 3
      iterations: 2

    # Enforce spatial coherence
    spatial_coherence:
      enabled: true
      neighborhood_radius: 1.0
      min_neighbor_agreement: 0.6

# ============================================================================
# OUTPUT CONFIGURATION
# ============================================================================
output:
  format: "laz"
  save_patches: true # ‚ú® REQUIRED for patch generation in "both" mode
  extra_dims:
    - planarity
    - linearity
    - sphericity
    - verticality
    - horizontality
    - curvature
    - density
    - height
    - height_above_ground
    - height_local
    - ndvi
    - nir_intensity
    - cluster_id
    - building_cluster_id
    - parcel_cluster_id
    - is_synthetic

  save_classification: true
  save_confidence_scores: false
  include_metadata: true
  metadata_format: "json"

# ============================================================================
# MONITORING & LOGGING - CPU MODE
# ============================================================================
monitoring:
  enabled: true
  log_level: "INFO"
  track_memory: true
  track_gpu_usage: false # Disabled for CPU mode
  track_processing_time: true
  progress_interval: 10
  compute_statistics: true
  save_statistics: true
  statistics_output: "processing_stats.json"

# ============================================================================
# CACHE CONFIGURATION
# ============================================================================
cache:
  enabled: true
  cache_dir: "./cache"
  cache_features: false
  cache_ground_truth: true
  cache_rgb: true
  cache_nir: true
  cache_dtm: true
  ground_truth_ttl_days: 180
  rgb_ttl_days: 365
  nir_ttl_days: 365
  dtm_ttl_days: 365

# ============================================================================
# VALIDATION & QUALITY CONTROL
# ============================================================================
validation:
  enabled: true
  check_point_density: true
  min_points_per_tile: 100_000
  check_feature_range: true
  flag_invalid_features: true
  check_class_distribution: true
  warn_on_high_unclassified: true
  max_unclassified_percentage: 15
  check_output_completeness: true
  verify_extra_dims: true
# ============================================================================
# USAGE NOTES - CPU OPTIMIZED VERSION
# ============================================================================
#
# VERSION: 6.3.3-cpu - MULTI-SCALE ARTIFACT-FREE + FACADE ENHANCED (CPU)
# CPU-OPTIMIZED CONFIGURATION
#
# üî• CPU CONFIGURATION PARAMETERS:
# 1. use_gpu: false - CPU processing mode
# 2. num_workers: 8 - Parallel CPU workers (adjust for your system)
# 3. chunk_size: 5M points - Optimal CPU batch size
# 4. track_gpu_usage: false - No GPU monitoring
#
# üíª CPU WORKER TUNING GUIDE:
# Set num_workers based on available CPU cores:
# - 4-core CPU: num_workers = 3-4
# - 6-core CPU: num_workers = 5-6
# - 8-core CPU: num_workers = 6-8 (recommended)
# - 12-core CPU: num_workers = 10-12
# - 16+ core CPU: num_workers = 12-16
#
# Rule of thumb: Use 75-85% of total cores to leave headroom for OS/other tasks
#
# üéØ MEMORY TUNING:
# If experiencing memory issues:
# - <32GB RAM: chunk_size = 3_000_000
# - 32-48GB RAM: chunk_size = 5_000_000 (current)
# - >64GB RAM: chunk_size = 8_000_000
#
# ‚è±Ô∏è EXPECTED PERFORMANCE (CPU MODE):
# System: 8-core CPU, 32GB RAM, 18M point tile
# - Feature computation: ~20-30 min (multi-scale CPU)
# - DTM augmentation: ~1-2 min
# - Ground truth: ~4-6 min (larger buffers)
# - Classification: ~3-5 min
# - Total: ~30-45 min per tile
#
# Comparison to GPU (RTX 4080):
# - CPU is ~2-3x slower overall
# - No VRAM limitations
# - Better for systems without powerful GPU
# - Can process larger tiles with sufficient RAM
#
# ÔøΩ FACADE DETECTION (unchanged from GPU version):
# 1. Lateral buffers: 1.5-12.0m - capture deep facades/courtyards
# 2. Verticality: 0.45-0.50 - catch textured/semi-vertical walls
# 3. Gap detection: 96 resolution, 4.0m band - find missing walls
# 4. Height thresholds: 1.5m min - include low walls/annexes
# 5. NDVI filtering: max 0.18-0.20 - strict vegetation exclusion
# 6. Search radius: 3.5m - find facades outside polygons
#
# üéØ MULTI-SCALE ARTIFACT REDUCTION (unchanged):
# 1. Three scales: Fine (1.0m/20nn), Medium (2.5m/50nn), Coarse (5.0m/100nn)
# 2. Variance-weighted aggregation with artifact detection
# 3. 50-75% reduction in scan line artifacts
# 4. Cleaner feature boundaries and geometry
#
# USAGE:
#   ign-lidar-hd process \
#     -c examples/production/asprs_memory_optimized.yaml \
#     input_dir="/data/lidar/tiles" \
#     output_dir="/data/output_cpu"
#
# PARALLEL PROCESSING NOTE:
# The library will automatically use scikit-learn's joblib for parallel
# CPU processing. KD-tree construction and feature computation will be
# parallelized across the specified num_workers.
#
# WHEN TO USE CPU VERSION:
# - No GPU available or GPU has <8GB VRAM
# - System has good CPU (8+ cores recommended)
# - Sufficient RAM (32GB+)
# - Processing time is not critical
# - Batch processing overnight
#
# WHEN TO USE GPU VERSION:
# - GPU with 12GB+ VRAM available (RTX 3080+, RTX 4080+)
# - Need faster processing (2-3x speedup)
# - Real-time or interactive processing
# - Large production runs
#
# OPTIMIZATION TIPS:
# 1. Increase num_workers if CPU utilization <80%
# 2. Decrease num_workers if memory usage >90%
# 3. Monitor with task manager/htop during processing
# 4. Use cache_enabled: true to avoid reprocessing
# 5. Process multiple tiles in parallel if RAM allows
#
# TROUBLESHOOTING:
# If processing too slow:
# 1. Increase num_workers (up to CPU core count)
# 2. Reduce multi_scale scales to 2 (fine + coarse)
# 3. Disable artifact_detection if not critical
# 4. Consider GPU version if available
#
# If out of memory:
# 1. Reduce chunk_size (3M or 2M)
# 2. Reduce num_workers
# 3. Disable DTM augmentation (augment_ground: false)
# 4. Process smaller tiles or split large tiles
#
# If facades still missing (same as GPU version):
# 1. Increase adaptive_buffer_max to 15m
# 2. Lower min_verticality to 0.40
# 3. Increase gap_detection_band_width to 5.0m
# 4. Check point density (<5 pts/m¬≤ problematic)
#
# ============================================================================
# ============================================================================

