# ============================================================================
# IGN LiDAR HD - Enhanced Training Configuration (50m patches, optimized)
# ============================================================================
# Created: November 21, 2025
#
# Optimized configuration with:
# - Building AND Water ground truth
# - Facade optimizations enabled
# - NDVI computation
# - Stitching enabled for boundary artifacts
# - Both LAZ enriched tiles AND NPZ patches
# - GPU: NVIDIA RTX 4080 (16GB VRAM)
#
# Complete feature-rich processing with quality optimization
# ============================================================================

defaults:
  - base/processor
  - base/features
  - base/data_sources
  - base/output
  - base/monitoring
  - _self_

config_version: "6.3.0"
preset_name: "training_enhanced_50m"

# ============================================================================
# PROCESSOR CONFIGURATION - SPEED OPTIMIZED
# ============================================================================
processor:
  lod_level: "LOD2"
  architecture: "hybrid"
  processing_mode: "both"
  output_format: "laz"

  # GPU Configuration - LARGER BATCHES
  use_gpu: true
  gpu_device: 0
  gpu_batch_size: 15_000_000 # 15M points (increased from 10M)
  gpu_memory_target: 0.90 # Use more VRAM
  vram_limit_gb: 14

  num_workers: 0

  # Patch Configuration
  patch_size: 50.0
  num_points: 32000
  overlap: 0.10 # Reduced overlap (5m instead of 7.5m)

  sampling_method: "fps"
  augment: false
  num_augmentations: 0

  batch_size: "auto"
  prefetch_factor: 2
  pin_memory: true

# ============================================================================
# PREPROCESSING - MINIMAL FOR SPEED
# ============================================================================
preprocess:
  enabled: true

  # Less aggressive outlier removal
  sor_k: 12 # Reduced from 16
  sor_std: 2.5 # More permissive

  ror_radius: 1.0
  ror_neighbors: 4 # Reduced from 5

  voxel_enabled: false

# ============================================================================
# STITCHING - ENABLED FOR QUALITY
# ============================================================================
stitching:
  enabled: true
  overlap_size: 5.0
  buffer_size: 2.5
  feature_blending: true
  blending_method: "distance_weighted"
  min_overlap_points: 100

# ============================================================================
# FEATURES - SPEED OPTIMIZED
# ============================================================================
features:
  mode: "lod2"

  # OPTIMAL NEIGHBORHOOD SIZE FOR QUALITY
  k_neighbors: 30 # Optimal for feature quality
  search_radius: 2.5 # 2.5m for accurate local features

  compute_normals: true
  compute_curvature: true
  compute_height: true
  compute_geometric: true
  compute_density: true
  compute_anisotropy: true
  compute_ndvi: true

  use_rgb: true
  use_infrared: true
  use_nir: true

  height_method: "local"
  compute_height_above_ground: true
  compute_height_local: true

  multi_scale_computation: false

  normalize_xyz: true
  normalize_features: true
  normalize_method: "z_score"

  # LARGER GPU BATCHES FOR SPEED
  gpu_batch_size: 5_000_000 # Increased from 3M
  use_gpu_chunked: true
  force_gpu: true

  # RGB augmentation - cached
  rgb_augmentation:
    enabled: true
    method: "orthophoto"
    resolution: 0.2
    cache_enabled: true
    cache_dir: null

  # Essential features only
  feature_selection:
    geometric_features:
      - normals
      - planarity
      - sphericity
      - verticality
      - horizontality
      - linearity
      - curvature
      - anisotropy

    height_features:
      - height
      - height_above_ground
      - height_local

    density_features:
      - point_density

    spectral_features:
      - rgb
      - ndvi

    radiometric_features:
      - intensity
      - return_number

    contextual_features:
      - local_point_count

# ============================================================================
# GROUND TRUTH - OPTIMIZED
# ============================================================================
ground_truth:
  enabled: true

  method: "gpu"
  chunk_size: 5_000_000 # Larger chunks

  cache_dir: null
  cache_ttl_days: 30
  cache_compression: true

  preclassify: true
  show_progress: false # Disable progress bars for speed

  bd_topo:
    enabled: true
    features:
      buildings:
        enabled: true
        facade_optimization: true
        min_height: 1.5
        buffer_distance: 0.5
      roads:
        enabled: true
        buffer_distance: 1.5
      vegetation:
        enabled: true
        buffer_distance: 0.0
      water:
        enabled: true
        buffer_distance: 0.5
      railways:
        enabled: false
      bridges:
        enabled: false
      power_lines:
        enabled: false

    parameters:
      road_width_fallback: 4.0
      use_spatial_index: true

    cache_enabled: true

# ============================================================================
# DATA SOURCES
# ============================================================================
data_sources:
  rge_alti:
    enabled: false

  bd_topo:
    enabled: true
    path: "./data/ground_truth/BDTOPO/"
    assign_building_cluster_ids: false # Disabled for speed
    assign_parcel_cluster_ids: false

    features:
      buildings:
        enabled: true
        file: "BATIMENT.shp"
        buffer_distance: 0.5
        facade_optimization: true
        min_facade_height: 1.5
        assign_cluster_ids: true
      roads:
        enabled: true
        file: "TRONCON_DE_ROUTE.shp"
        buffer_distance: 1.5
        classification_method: "surface_type"
      vegetation:
        enabled: true
        file: "ZONE_DE_VEGETATION.shp"
        buffer_distance: 0.0
      water:
        enabled: true
        file: "SURFACE_EAU.shp"
        buffer_distance: 0.5
      ground:
        enabled: false

# ============================================================================
# CLASSIFICATION
# ============================================================================
classification:
  mode: "lod2"
  normalize_classes: true
  strict_normalization: false

  lod2_classes:
    enabled: true
    classes:
      - 1 # Unclassified
      - 2 # Ground
      - 3 # Low Vegetation
      - 4 # Medium Vegetation
      - 5 # High Vegetation
      - 6 # Building
      - 9 # Water
      - 11 # Road
      - 17 # Bridge
      - 64 # Building Facade

  height_classification:
    enabled: true
    low_vegetation_max: 0.5
    medium_vegetation_max: 2.0
    high_vegetation_min: 2.0

  ndvi_classification:
    enabled: true
    vegetation_threshold: 0.3
    strong_vegetation_threshold: 0.5

  thresholds:
    buildings:
      min_height: 1.5
      min_verticality: 0.55 # Slightly relaxed
      min_roof_planarity: 0.65
      max_roof_curvature: 0.20

    ground:
      max_height: 0.5
      min_planarity: 0.75
      min_horizontality: 0.70

    vegetation:
      min_ndvi: 0.3
      max_planarity: 0.6
      max_verticality: 0.4

# ============================================================================
# RECLASSIFICATION - STRATEGIC CLASS-BASED REFINEMENT
# ============================================================================
reclassification:
  enabled: true

  # Strategy: Different confidence thresholds based on base class reliability
  # Buildings: Conservative (high confidence required to change)
  # Unclassified/Vegetation: Aggressive (lower confidence to refine)

  strategy: "class_based"
  use_neighbors: true
  k_neighbors: 30

  # Building reclassification (CONSERVATIVE)
  buildings:
    enabled: true
    min_confidence: 0.75 # High confidence required to change building class
    preserve_if_vertical: true
    min_verticality: 0.60
    min_height: 1.5

    # Only allow specific transitions from buildings
    allowed_transitions:
      6: # From Building
        - 64 # To Building Facade (OK)
        - 6 # Keep Building (OK)
      64: # From Building Facade
        - 6 # To Building (OK)
        - 64 # Keep Facade (OK)

    # Strong geometric requirements to reclassify OUT of building
    reclassify_to_other:
      min_confidence: 0.90 # Very high confidence needed
      require_low_verticality: true
      max_verticality: 0.40
      require_low_planarity: true
      max_planarity: 0.50

  # Ground reclassification (MODERATE)
  ground:
    enabled: true
    min_confidence: 0.65
    max_height: 0.5
    min_horizontality: 0.70
    min_planarity: 0.75

    allowed_transitions:
      2: # From Ground
        - 2 # Keep Ground
        - 11 # To Road (similar)

  # Vegetation reclassification (AGGRESSIVE)
  vegetation:
    enabled: true
    min_confidence: 0.50 # Lower confidence OK for vegetation refinement

    # Easy transitions between vegetation types
    allowed_transitions:
      3: # From Low Vegetation
        - 3 # Keep Low Veg
        - 4 # To Medium Veg
        - 2 # To Ground (if very low)
      4: # From Medium Vegetation
        - 3 # To Low Veg
        - 4 # Keep Medium Veg
        - 5 # To High Veg
      5: # From High Vegetation
        - 4 # To Medium Veg
        - 5 # Keep High Veg

    # Height-based refinement
    height_refinement:
      enabled: true
      low_veg_max: 0.5
      medium_veg_min: 0.5
      medium_veg_max: 2.0
      high_veg_min: 2.0

    # NDVI-based refinement
    ndvi_refinement:
      enabled: true
      min_ndvi_threshold: 0.3
      strong_veg_threshold: 0.5

  # Unclassified reclassification (VERY AGGRESSIVE)
  unclassified:
    enabled: true
    min_confidence: 0.40 # Low confidence OK to classify unclassified points

    # Allow transition to any class with reasonable confidence
    allowed_transitions:
      1: # From Unclassified
        - 2 # To Ground
        - 3 # To Low Veg
        - 4 # To Medium Veg
        - 5 # To High Veg
        - 6 # To Building
        - 9 # To Water
        - 11 # To Road
        - 64 # To Facade

    # Use neighboring points heavily
    neighbor_voting:
      enabled: true
      min_neighbor_agreement: 0.60 # 60% of neighbors agree
      weight_by_distance: true

  # Water reclassification (MODERATE-CONSERVATIVE)
  water:
    enabled: true
    min_confidence: 0.70
    max_height: 1.0 # Water should be low
    min_horizontality: 0.75

    allowed_transitions:
      9: # From Water
        - 9 # Keep Water
        - 2 # To Ground (if dry)

  # Road reclassification (MODERATE)
  roads:
    enabled: true
    min_confidence: 0.65
    max_height: 0.5
    min_horizontality: 0.70

    allowed_transitions:
      11: # From Road
        - 11 # Keep Road
        - 2 # To Ground

  # Global refinement settings
  refinement:
    enabled: true

    # Multi-pass refinement with decreasing aggressiveness
    passes:
      - name: "aggressive_unclassified"
        target_classes: [1] # Unclassified only
        min_confidence: 0.40
        use_neighbors: true

      - name: "vegetation_height_refinement"
        target_classes: [3, 4, 5] # All vegetation
        min_confidence: 0.50
        use_height: true

      - name: "conservative_building_refinement"
        target_classes: [6, 64] # Buildings and facades
        min_confidence: 0.75
        preserve_vertical: true

    # Contextual refinement using spatial neighbors
    spatial_refinement:
      enabled: true
      search_radius: 3.0
      min_neighbors: 10

      # Isolated point cleaning
      remove_isolated:
        enabled: true
        min_cluster_size: 5
        classes_to_clean: [1, 3, 4] # Clean isolated unclassified and low veg

      # Majority voting for uncertain points
      majority_voting:
        enabled: true
        confidence_threshold: 0.55
        min_neighbor_agreement: 0.70

  # Quality control
  validation:
    enabled: true

    # Check that reclassification improves quality
    require_improvement: true
    min_confidence_gain: 0.10

    # Log reclassification statistics
    log_transitions: true
    log_confidence_changes: true

    # Warnings for suspicious reclassifications
    warn_large_changes: true
    max_change_percentage: 20.0 # Warn if >20% of points change class

# ============================================================================
# OUTPUT
# ============================================================================
output:
  format: "laz"

  enriched_laz:
    enabled: true
    output_dir: "enriched_tiles"
    compression: true

  patches:
    enabled: true
    format: "npz"
    output_dir: "patches"
    save_laz: true
    laz_output_dir: "patches_laz"

  output_structure: "flat"
  patch_naming: "coordinates"

  # Complete extra dimensions including facade features
  extra_dims:
    - planarity
    - verticality
    - horizontality
    - linearity
    - sphericity
    - anisotropy
    - eigenentropy
    - curvature
    - height
    - height_above_ground
    - height_local
    - point_density
    - local_point_count
    - ndvi
    - intensity
    - return_number
    - number_of_returns
    - confidence_score
    - building_cluster_id
    - facade_distance

  save_classification: true
  save_confidence_scores: true

  include_metadata: true
  metadata_format: "json"

  save_split_info: true
  split_ratios:
    train: 0.70
    val: 0.15
    test: 0.15

# ============================================================================
# PYTORCH
# ============================================================================
pytorch:
  enabled: true
  dataset_class: "IGNLiDARMultiArchDataset"
  preset: "buildings"
  architecture: "hybrid"

  input_features:
    - xyz
    - normals
    - planarity
    - verticality
    - height_above_ground
    - rgb
    - intensity

  target: "classification"

  batch_size: 8
  num_workers: 4
  shuffle: true
  pin_memory: true
  drop_last: true

  augmentation:
    enabled: false

# ============================================================================
# MONITORING - REDUCED OVERHEAD
# ============================================================================
monitoring:
  enabled: true
  log_level: "INFO"

  track_memory: true
  track_gpu_usage: true
  track_processing_time: true

  progress_interval: 10 # Less frequent updates

  compute_statistics: true
  save_statistics: true
  statistics_output: "training_dataset_stats.json"

  save_class_distribution: true
  warn_class_imbalance: true
  max_class_imbalance_ratio: 10.0

# ============================================================================
# CACHE
# ============================================================================
cache:
  enabled: true
  cache_dir: null

  cache_features: false
  cache_ground_truth: true
  cache_rgb: true
  cache_kdtrees: true

  ground_truth_ttl_days: 90
  rgb_ttl_days: 180

# ============================================================================
# VALIDATION - RELAXED FOR SPEED
# ============================================================================
validation:
  enabled: true

  check_point_density: true
  min_points_per_tile: 50_000 # Reduced threshold

  check_patch_completeness: true
  min_points_per_patch: 28000 # Slightly relaxed
  reject_incomplete_patches: false # Don't reject for speed

  check_feature_range: true
  flag_invalid_features: true
  check_nan_values: true
  reject_patches_with_nans: false # Flag but don't reject

  check_class_distribution: false # Disabled for speed
  check_output_completeness: true
  verify_extra_dims: true
# ============================================================================
# USAGE & NOTES
# ============================================================================
#
# USAGE:
#   ign-lidar-hd process \
#     -c examples/config_training_fast_50m.yaml \
#     input_dir="/mnt/c/Users/Simon/ign_lidar/unified_dataset_rgb" \
#     output_dir="/mnt/c/Users/Simon/ign_lidar/training_enhanced"
#
# ENHANCED FEATURES:
#   ✅ Building ground truth with facade optimization
#   ✅ Water ground truth classification
#   ✅ Complete NDVI computation (RGB + NIR)
#   ✅ Stitching enabled for boundary quality
#   ✅ Both enriched LAZ tiles AND NPZ patches
#   ✅ Facade-specific features and classifications
#   ✅ Complete geometric features (30 neighbors, 2.5m radius)
#   ✅ Building cluster IDs for instance segmentation
#   ✅ Comprehensive extra dimensions (20+ features)
#
# OUTPUT FORMATS:
#   - Enriched LAZ tiles: Complete tiles with all features
#   - NPZ patches: 50m patches for ML training
#   - LAZ patches: Individual patch LAZ files
#   - Metadata: JSON files with processing statistics
#
# GROUND TRUTH SOURCES:
#   - Buildings: BATIMENT.shp (BD TOPO)
#   - Water: SURFACE_EAU.shp (BD TOPO)
#   - Roads: TRONCON_DE_ROUTE.shp (BD TOPO)
#   - Vegetation: ZONE_DE_VEGETATION.shp (BD TOPO)
#
# WHEN TO USE:
#   - Production-quality training datasets
#   - Building facade analysis
#   - Water body detection
#   - Complete semantic segmentation
#   - Instance segmentation with building IDs
#
# ============================================================================
