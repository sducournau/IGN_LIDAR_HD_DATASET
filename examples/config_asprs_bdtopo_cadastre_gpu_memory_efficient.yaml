# ============================================================================
# IGN LiDAR HD - ASPRS GPU Memory-Efficient Configuration
# ============================================================================
# Purpose: GPU-accelerated ASPRS classification with conservative memory usage
#
# Optimizations for systems with limited RAM (32GB) but GPU available:
# - GPU acceleration for compute-intensive operations
# - Conservative batch sizes to prevent OOM
# - Chunked processing with GPU streaming
# - Reduced DTM augmentation to save RAM
# - Memory pooling and async transfers
#
# Hardware Requirements:
# - GPU: 8GB+ VRAM (RTX 3060, RTX 4060, or better)
# - RAM: 32GB system memory
# - CUDA: 11.0+
# - Python packages: cupy-cuda11x, cudf-cu11
#
# Expected Performance (RTX 3060/4060, 32GB RAM):
# - Processing speed: ~50-80M points/minute (GPU-accelerated)
# - Memory usage: Kept under 70% (~22GB RAM)
# - VRAM usage: ~5-6GB (conservative)
# - Total time per tile: ~10-18 min for 20M point tiles
#
# Memory-saving optimizations:
# - Reduced k_neighbors: 60 → 55
# - Reduced batch sizes: 10M → 5M points
# - Reduced DTM augmentation: 2.5m → 3.0m spacing
# - FAISS auto-fallback to CPU for >15M points
# - More aggressive memory cleanup
#
# Usage:
#   ign-lidar-hd process \
#     -c examples/config_asprs_bdtopo_cadastre_gpu_memory_efficient.yaml \
#     input_dir="/path/to/tiles" \
#     output_dir="/path/to/output"
# ============================================================================

defaults:
  - base/processor
  - base/features
  - base/data_sources
  - base/output
  - base/monitoring
  - _self_

# Configuration metadata
config_version: "5.3.2"
config_name: "asprs_bdtopo_cadastre_gpu_optimized"
config_description: "GPU-Optimized ASPRS with 1m² DTM Augmentation (32GB+ RAM, 8GB+ VRAM)"

# ============================================================================
# PROCESSOR - GPU Memory-Efficient Settings
# ============================================================================
processor:
  lod_level: "ASPRS"
  processing_mode: "enriched_only"

  # ============================================================================
  # GPU OPTIMIZATION - Optimized Settings for 8-16GB VRAM
  # ============================================================================
  use_gpu: true
  gpu_batch_size: 8_000_000 # Increased from 5M for better throughput
  gpu_memory_target: 0.80 # Increased from 0.70 for better GPU utilization
  gpu_streams: 6 # Increased from 4 for better parallelism

  # Memory management
  enable_memory_pooling: true
  enable_async_transfers: true
  enable_pipeline_optimization: true
  auto_optimize: true
  adaptive_chunk_sizing: true
  use_cuda_streams: true

  # VRAM limits
  vram_limit_gb: 8 # Increased from 6GB for better performance
  cleanup_frequency: 3 # Standard cleanup frequency

  # CPU fallback settings (MUST be 1 for GPU mode due to CUDA context limitations)
  num_workers: 1 # Required for GPU - CUDA contexts cannot be shared across processes
  chunk_size: 8_000_000 # Increased to match gpu_batch_size

  # Ground truth processing
  ground_truth_method: "auto" # Auto-select GPU/CPU based on availability
  ground_truth_chunk_size: 8_000_000 # Increased to match batch size
  use_optimized_ground_truth: true

  # Strategy pattern
  use_strategy_pattern: true

  # Processing settings
  skip_existing: false
  output_format: "laz"
  use_stitching: false

  # Patch extraction (disabled)
  patch_size: 50.0
  patch_overlap: 0.1
  num_points: 24576
  architecture: "direct"
  augment: false

  # ============================================================================
  # RECLASSIFICATION - GPU-Accelerated
  # ============================================================================
  reclassification:
    enabled: true
    acceleration_mode: "gpu" # Force GPU for better performance
    chunk_size: 6_000_000 # Increased from 3M for better throughput
    min_confidence: 0.75
    use_geometric_rules: true
    use_ndvi_classification: true
    show_progress: true
    ndvi_vegetation_threshold: 0.3
    ndvi_road_threshold: 0.15
    use_spectral_rules: true
    nir_vegetation_threshold: 0.35
    nir_building_threshold: 0.25
    use_clustering: true
    spatial_cluster_eps: 0.4
    min_cluster_size: 8
    building_buffer_distance: 3.5
    verticality_threshold: 0.65

  # Building clustering
  building_clustering:
    enabled: true
    use_centroid_attraction: true
    attraction_radius: 5.5
    min_points_per_building: 10
    adjust_polygons: true
    polygon_buffer: 0.5
    wall_buffer: 0.3
    detect_near_vertical_walls: true

# ============================================================================
# FEATURES - GPU-Accelerated with Memory Efficiency
# ============================================================================
features:
  mode: "asprs_classes"
  include_extra: true

  # Optimized parameters for GPU processing
  k_neighbors: 60 # Increased from 55 for better feature quality
  search_radius: 1.5

  # ============================================================================
  # GPU SETTINGS - Optimized Batching
  # ============================================================================
  use_gpu: true
  use_gpu_chunked: true
  gpu_batch_size: 8_000_000 # Increased from 5M for better throughput

  # Optimized batch sizes for performance
  neighbor_query_batch_size: 8_000_000 # Increased from 5M
  feature_batch_size: 6_000_000 # Increased from 3M

  # Essential features
  compute_normals: true
  compute_curvature: true
  compute_height: true
  compute_geometric: true

  # Additional geometric features
  compute_planarity: true
  compute_verticality: true
  compute_linearity: true
  compute_sphericity: true
  compute_eigenfeatures: true

  # Height computation - High-quality approach
  height_method: "hybrid"
  use_rge_alti_for_height: true
  dtm_interpolation: "cubic" # Higher quality interpolation
  compute_height_above_ground: true
  compute_height_local: true
  compute_z_from_dtm: true

  # Spectral features
  use_rgb: true
  use_nir: true
  use_infrared: true
  compute_ndvi: true

  # Disable expensive features
  compute_architectural: false
  architectural_styles: false
  compute_boundaries: false
  compute_multiscale: false

  # Caching
  enable_caching: true
  cache_max_size: 50
  enable_auto_tuning: true
  validate_features: true
  handle_nan_values: true

# ============================================================================
# VARIABLE OBJECT FILTERING
# ============================================================================
variable_object_filtering:
  enabled: true
  filter_vehicles: true
  vehicle_height_range: [0.8, 4.0]
  filter_urban_furniture: true
  furniture_height_range: [0.5, 4.0]
  furniture_max_cluster_size: 50
  filter_walls: false
  wall_height_range: [0.5, 2.5]
  wall_min_verticality: 0.8
  reclassify_to: 1
  create_vehicle_class: true
  vehicle_class_code: 18
  verbose: true

  # ============================================================================
  # BUILDING FUSION - GPU-Accelerated
  # ============================================================================
  building_fusion:
    enabled: true
    source_priority:
      - "bd_topo"
      - "cadastre"
      - "osm"
    min_quality_score: 0.50
    quality_difference_threshold: 0.10
    fusion_mode: "best"
    enable_multi_source_fusion: true
    enable_translation: true
    max_translation: 6.0
    enable_scaling: true
    max_scale_factor: 1.8
    enable_rotation: false # Disabled for performance
    max_rotation: 15.0
    enable_buffering: true
    adaptive_buffer_range: [0.8, 2.0]
    min_points_per_building: 12
    wall_detection_threshold: 0.60
    overlap_threshold: 0.28
    merge_nearby_buildings: true
    merge_distance_threshold: 2.0

  building_clustering:
    enabled: true
    use_centroid_attraction: true
    attraction_radius: 6.0
    min_points_per_building: 8
    adjust_polygons: false
    polygon_buffer: 0.0
    wall_buffer: 0.0
    detect_near_vertical_walls: true

  # ============================================================================
  # ADAPTIVE BUILDING CLASSIFICATION
  # ============================================================================
  adaptive_building_classification:
    enabled: true
    signature:
      min_height: 1.2
      typical_height_range: [2.0, 60.0]
      wall_verticality_min: 0.60
      wall_planarity_max: 0.65
      roof_planarity_min: 0.70
      roof_curvature_max: 0.10
      roof_normal_z_range: [0.25, 1.0]
      ndvi_max: 0.28
      ndvi_wall_max: 0.22
      min_cluster_size: 8
      max_isolation_distance: 6.0
    fuzzy_boundary_inner: 0.0
    fuzzy_boundary_outer: 2.5
    fuzzy_decay_function: "gaussian"
    enable_adaptive_expansion: true
    max_expansion_distance: 3.5
    expansion_confidence_threshold: 0.65
    enable_intelligent_rejection: true
    rejection_confidence_threshold: 0.45
    enable_spatial_clustering: true
    spatial_radius: 2.5
    min_neighbor_ratio: 0.25
    min_classification_confidence: 0.55
    feature_weights:
      height: 0.22
      geometry: 0.35
      spectral: 0.18
      spatial: 0.15
      ground_truth: 0.10

  # ============================================================================
  # PLANE DETECTION
  # ============================================================================
  plane_detection:
    enabled: true
    horizontal_angle_max: 15.0
    horizontal_planarity_min: 0.68
    vertical_angle_min: 70.0
    vertical_planarity_min: 0.58
    inclined_angle_min: 15.0
    inclined_angle_max: 70.0
    inclined_planarity_min: 0.62
    min_points_per_plane: 35
    max_plane_distance: 0.20
    use_spatial_coherence: true
    classify_roof_types: true
    detect_architectural_elements: false

# ============================================================================
# DATA SOURCES
# ============================================================================
data_sources:
  bd_topo:
    enabled: true
    features:
      buildings: true
      roads: true
      water: true
      vegetation: false
    wfs_url: "https://data.geopf.fr/wfs"
    max_features: 10000
    timeout: 30
    cache_enabled: true
    cache_dir: null
    use_global_cache: false
    use_gpu: true # Use GPU for spatial operations if available
    road_buffer: 2.5
    building_priority: 1
    road_priority: 2
    water_priority: 3
    vegetation_priority: 4

  bd_topo_bridges: true
  bd_topo_power_lines: true
  bd_topo_sports: true
  bd_topo_cemeteries: true
  bd_topo_parking: false

  cadastre:
    enabled: true
    wfs_url: "https://data.geopf.fr/wfs"
    typename: "CADASTRALPARCELS.PARCELLAIRE_EXPRESS:parcelle"
    use_as_building_proxy: true
    cache_dir: null

  cadastre_enabled: true
  cadastre_cache_dir: null

  osm:
    enabled: true
    overpass_url: "https://overpass-api.de/api/interpreter"
    timeout: 180
    building_tags:
      - "building=yes"
      - "building=house"
      - "building=residential"
      - "building=apartments"
      - "building=commercial"
      - "building=industrial"
      - "building=retail"
      - "building=office"
      - "building=school"
      - "building=church"
      - "building=hospital"
    min_building_area: 8.0
    max_building_area: 15000.0
    cache_enabled: true
    cache_dir: null
    cache_ttl_days: 30

  # ============================================================================
  # RGE ALTI - MODERATE AUGMENTATION (Memory-Efficient)
  # ============================================================================
  rge_alti:
    enabled: true
    use_wcs: true
    use_local: false
    wcs_url: "https://wxs.ign.fr/altimetrie/geoportail/r/wcs"
    coverage_id: "ELEVATION.ELEVATIONGRIDCOVERAGE.HIGHRES"
    api_key: "pratique"
    resolution: 1.0
    local_dtm_dir: null
    cache_enabled: true
    cache_dir: null
    cache_ttl_days: 90

    # MODERATE augmentation - balance quality and performance
    augment_ground_points: true
    augmentation_spacing: 2.0 # Reduced from 1.0m to stay under 15M points threshold
    augmentation_areas:
      - "vegetation" # Critical for height accuracy
      - "gaps" # Fill coverage gaps
      # buildings disabled to keep point count low for GPU FAISS

    compute_height_from_dtm: true
    dtm_height_priority: "medium"

  bd_foret_enabled: false
  rpg_enabled: false
  orthophoto_rgb: true
  orthophoto_nir: true
  orthophoto_cache_dir: null

# ============================================================================
# GROUND TRUTH - GPU-Accelerated with Fallback
# ============================================================================
ground_truth:
  enabled: true
  method: "gpu" # Force GPU for best performance
  chunk_size: 8_000_000 # Increased to match other batch sizes
  cache_dir: null
  cache_ttl_days: 30
  cache_compression: true
  preclassify: true
  show_progress: true
  use_gpu: true # Enable GPU if available

  # Adaptive ground truth
  adaptive_mode: true
  fuzzy_boundary_enabled: true
  fuzzy_boundary_inner: 0.0
  fuzzy_boundary_outer: 2.5
  fuzzy_decay_function: "gaussian"
  adaptive_expansion_enabled: true
  max_expansion_distance: 3.5
  expansion_confidence_threshold: 0.65
  intelligent_rejection_enabled: true
  rejection_confidence_threshold: 0.45
  reject_vegetation_in_polygons: true
  reject_outliers_in_polygons: true

  # RGE ALTI settings - MODERATE augmentation (2m² for GPU FAISS)
  rge_alti:
    enabled: true
    augment_ground: true
    augmentation_strategy: "intelligent" # Smart placement
    augmentation_spacing: 2.0 # 2m spacing to stay under 15M points for GPU FAISS
    min_spacing_to_existing: 1.5 # Balanced spacing
    augmentation_priority:
      vegetation: true # High priority
      buildings: false # Disabled to keep point count low
      water: false # Disabled to keep point count low
      roads: false # Disabled to keep point count low
      gaps: true # High priority
    max_height_difference: 3.0 # Standard validation threshold
    validate_against_neighbors: true
    synthetic_ground_class: 2
    mark_as_synthetic: true

  bd_topo:
    enabled: true
    classification_mapping:
      buildings: 6
      roads: 11
      railways: 10
      water: 9
      low_vegetation: 3
      medium_vegetation: 4
      high_vegetation: 5
      bridges: 17
      parking: 11
      cemeteries: 2
      sports: 11
      power_lines: 14
    road_buffer: 3.0
    railway_buffer: 2.5
    power_line_buffer: 6.0
    building_buffer: 1.2
    water_buffer: 1.5
    road_width_fallback: 5.0
    railway_width_fallback: 4.0
    road_min_width: 1.5
    road_max_width: 60.0

  cadastre:
    enabled: true
    min_parcel_area: 8.0
    min_parcel_points: 15
    group_by_parcel: true
    export_parcel_stats: true

  integration:
    method: "priority_based"
    priority:
      bd_topo: 1
      cadastre: 2
      orthophoto: 4
      geometric_rules: 5
    confidence_threshold: 0.65

  quality_control:
    enabled: true
    validate_geometries: true
    check_coverage: true
    min_coverage_ratio: 0.15

  parallel_fetch: true
  max_parallel_requests: 16 # Increased parallelism for faster data fetching

# ============================================================================
# OUTPUT CONFIGURATION
# ============================================================================
output:
  format: "laz"
  save_enriched: true
  save_patches: false
  save_metadata: true
  save_stats: true
  compression: null
  validate_output: true
  save_fusion_report: true
  save_quality_scores: true
  save_adapted_polygons: true
  save_dtm_augmentation_report: true
  save_dtm_grid: false
  save_height_comparison: true
  include_dtm_height: true
  include_local_height: true
  include_dtm_elevation: true
  include_synthetic_flag: true
  save_adaptive_report: true
  include_confidence_scores: true
  extra_dims:
    - name: "BuildingConfidence"
      type: "float32"
      description: "Building classification confidence (0-1)"
    - name: "IsWall"
      type: "uint8"
      description: "1 if point is likely a wall"
    - name: "IsRoof"
      type: "uint8"
      description: "1 if point is likely a roof"
    - name: "DistanceToPolygon"
      type: "float32"
      description: "Signed distance to nearest building polygon (m)"
    - name: "AdaptiveExpanded"
      type: "uint8"
      description: "1 if classified via adaptive expansion"
    - name: "IntelligentRejected"
      type: "uint8"
      description: "1 if rejected despite being in polygon"
  export_parcel_stats: true
  parcel_stats_format: "csv,geojson,html"

# ============================================================================
# LOGGING
# ============================================================================
logging:
  level: INFO
  show_progress: true
  detailed_timing: true
  enable_performance_metrics: true
  enable_profiling: false

# ============================================================================
# PREPROCESSING & STITCHING
# ============================================================================
preprocess:
  enabled: false
  remove_duplicates: true
  remove_outliers: true
  outlier_std_multiplier: 3.0

stitching:
  enabled: false
  buffer_size: 10.0
  blend_overlap: true

# ============================================================================
# OPTIMIZATIONS - GPU-Specific
# ============================================================================
optimizations:
  enable_caching: true
  cache_max_size_mb: 256 # Increased cache size
  enable_parallel_processing: false # Disabled for GPU mode (CUDA limitation)
  max_workers: 1 # Required for GPU - CUDA contexts cannot be shared
  enable_auto_tuning: true
  adaptive_parameters: true
  enable_performance_metrics: true
  enable_profiling: false

validation:
  strict_validation: true
  check_gpu_availability: true
  check_memory_requirements: true

hardware:
  auto_detect: true
  prefer_gpu: true
  fallback_cpu: true

# ============================================================================
# HYDRA CONFIGURATION
# ============================================================================
hydra:
  run:
    dir: outputs/asprs_bdtopo_cadastre_gpu_optimized/${now:%Y-%m-%d}/${now:%H-%M-%S}
  job:
    name: asprs_bdtopo_cadastre_gpu_optimized
# ============================================================================
# EXPECTED RESULTS (GPU-Optimized with 2m² DTM Augmentation - v5.3.2)
# ============================================================================
# Performance (RTX 3060/4060, 32GB+ RAM, 20M point tile):
#   - Feature computation: ~90-180 sec (GPU FAISS-accelerated k-NN)
#   - DTM ground augmentation: ~1-2 min (2m² spacing = ~50-80K synthetic points)
#     * Synthetic points added: ~50-80K (moderate density)
#     * Memory footprint: ~400-640MB
#   - Building fusion: ~2-3 min
#   - Ground truth classification: ~1-2 min (GPU-accelerated)
#   - Classification: ~25-50 sec (GPU-accelerated)
#   - I/O: ~2-3 min
#   - Total: ~8-14 min per tile
#
# Memory Usage (optimized for 32GB+ RAM, 8GB+ VRAM):
#   - System RAM: 18-24GB peak (~55-75% of 32GB)
#   - VRAM: 5-7GB peak (~60-85% of 8GB GPU)
#
# Quality (balanced with 2m² DTM augmentation):
#   - Overall accuracy: 89-96%
#   - Building detection: 92-97%
#   - Building completeness: 87-95%
#   - Road detection: 81-91%
#   - Vegetation classification: 86-92%
#   - Ground elevation accuracy: <15cm RMSE
#
# GPU Optimizations (v5.3.2):
#   - Increased batch sizes: 5M → 8M points per batch
#   - Increased k_neighbors: 55 → 60 for better features
#   - Higher GPU utilization: 70% → 80% target
#   - More CUDA streams: 4 → 6 for better parallelism
#   - Increased parallelism: 10 → 16 parallel requests
#   - Higher quality interpolation: bilinear → cubic
#   - GPU FAISS enabled: Stays under 15M point threshold
#
# DTM Augmentation (2m² spacing):
#   - Moderate synthetic ground points for balanced quality/performance
#   - Keeps total point count under 15M for GPU FAISS acceleration
#   - Coverage in vegetation and gaps (most critical areas)
#   - Validated against neighbors (max 3.0m height difference)
#   - Min spacing to existing: 1.5m for balanced density
#
# Key Advantage - GPU FAISS:
#   - Point cloud stays under 15M threshold
#   - GPU FAISS k-NN: ~90-180 seconds (vs 26 minutes CPU FAISS)
#   - 8-10× faster overall processing
#   - Still excellent quality with 2m² DTM spacing
#
# Requirements:
#   - GPU: 8GB+ VRAM recommended (RTX 3060 Ti, RTX 4060 Ti, or better)
#   - RAM: 32GB+ system memory recommended
#   - CUDA: 11.0+
#   - Storage: Additional space for dense DTM augmentation
# ============================================================================
