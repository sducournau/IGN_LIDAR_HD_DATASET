---
sidebar_position: -5
title: v2.2.0 - Multi-Format Support
---

# v2.2.0 - Multi-Format Output Support

**Release Date:** October 10, 2025  
**Type:** Feature Release

---

## üéâ Overview

Version 2.2.0 introduces powerful multi-format output capabilities, allowing you to save patches in multiple formats simultaneously. This release also fixes a critical HDF5 bug and adds new tools for format conversion and visualization.

---

## üöÄ Key Features

### 1. Multi-Format Output

Save patches in multiple formats with a single processing run:

```yaml
output:
  format: hdf5,laz  # Both HDF5 and LAZ
```

**Supported combinations:**
- `npz,hdf5` - NumPy + HDF5
- `hdf5,laz` - HDF5 + LAZ for visualization
- `npz,torch` - NumPy + PyTorch tensors
- `npz,hdf5,laz` - All three formats
- Any combination you need!

### 2. Complete Format Support

All output formats are now fully implemented:

| Format | Extension | Description | Status |
|--------|-----------|-------------|--------|
| **NPZ** | `.npz` | NumPy compressed archives | ‚úÖ Default |
| **HDF5** | `.h5` | Hierarchical data with gzip compression | ‚úÖ Fixed |
| **PyTorch** | `.pt` | PyTorch tensor files | ‚úÖ New |
| **LAZ** | `.laz` | Point cloud for visualization | ‚úÖ New |

### 3. LAZ Patch Export

Patches can now be saved as LAZ point clouds:

```bash
# Save as LAZ for visualization
ign-lidar-hd process \
  input_dir=data/tiles \
  output_dir=data/patches \
  output.format=laz
```

**Compatible with:**
- CloudCompare
- QGIS
- PDAL
- LAStools
- FME

**LAZ patches include:**
- XYZ coordinates
- Classification labels
- RGB colors
- Intensity values
- All geometric features as extra dimensions

### 4. HDF5 to LAZ Conversion Tool

New script for converting existing HDF5 patches to LAZ:

```bash
# Convert single file
python scripts/convert_hdf5_to_laz.py patch_0001.h5

# Convert directory
python scripts/convert_hdf5_to_laz.py patches/ output_laz/

# Inspect HDF5 structure
python scripts/convert_hdf5_to_laz.py --inspect patch_0001.h5
```

### 5. Hybrid Architecture Formatter

New `HybridFormatter` class for ensemble/hybrid models:

```python
from ign_lidar.io.formatters import HybridFormatter

formatter = HybridFormatter(
    target_architectures=['pointnet++', 'octree', 'transformer']
)
```

Saves all architecture formats in a single file for maximum flexibility.

---

## üêõ Critical Bug Fixes

### HDF5 Output Bug (FIXED)

**Problem:** Previous versions silently failed to generate HDF5 files when `output.format=hdf5` was specified.

**Solution:** Complete HDF5 implementation with proper file generation and gzip compression.

**Impact:** All users who attempted to use HDF5 format should rerun processing.

### Output Format Implementation Gaps

- HDF5 saving was documented but not implemented ‚ùå ‚Üí ‚úÖ Fixed
- PyTorch format was documented but not implemented ‚ùå ‚Üí ‚úÖ Fixed
- LAZ patch format was not available ‚ùå ‚Üí ‚úÖ Added

---

## üìù Changes

### Added

- **Multi-Format Output Support**: Save patches in multiple formats simultaneously
  - New format string parsing: `hdf5,laz` saves both HDF5 and LAZ patch files
  - Supports any combination: `npz`, `hdf5`, `pytorch`/`torch`, `laz`
  - Added multi-format configuration preset: `ign_lidar/configs/output/multi.yaml`

- **LAZ Patch Export**: New LAZ output format for patch files
  - Patches saved as LAZ point clouds for visualization
  - Compatible with CloudCompare, QGIS, PDAL, and other LiDAR tools
  - Includes coordinates, classification, RGB, intensity, and features as extra dimensions
  - New method `_save_patch_as_laz()` in processor

- **HDF5 Format Support**: Fixed and enhanced HDF5 output
  - Proper HDF5 file generation with gzip compression
  - Supports all patch data: points, features, labels, RGB, NIR, normals

- **PyTorch Format Support**: Native PyTorch tensor output
  - Direct `.pt` file generation with torch tensors
  - Automatic NumPy to PyTorch tensor conversion
  - Requires PyTorch installation (optional dependency)

- **Hybrid Architecture Formatter**: Comprehensive single-file format
  - New `HybridFormatter` class for ensemble/hybrid models
  - Saves all architecture formats in one file for maximum flexibility
  - Includes KNN graph, voxel representation, and all feature types

- **HDF5 to LAZ Conversion Tool**: New script `scripts/convert_hdf5_to_laz.py`
  - Convert HDF5 patches back to LAZ format for visualization
  - Batch conversion support for directories
  - Inspection mode to view HDF5 file structure
  - Comprehensive documentation in `scripts/CONVERT_HDF5_TO_LAZ.md`

- **Format Validation**: Automatic validation of output format specifications
  - Clear error messages for unsupported formats
  - PyTorch availability checking
  - Multi-format syntax validation

### Fixed

- **HDF5 Output Bug**: Critical fix for HDF5 format not saving any files
  - Previous versions silently failed to generate HDF5 files
  - Now properly saves HDF5 patches with compression

- **Output Format Implementation Gaps**: Completed missing format implementations
  - HDF5 saving was documented but not implemented
  - PyTorch format was documented but not implemented
  - LAZ patch format is now available

### Changed

- **Output Format Configuration**: Enhanced format specification
  - Old: Single format only (`format: hdf5`)
  - New: Multi-format support (`format: hdf5,laz`)
  - Updated documentation to reflect actual supported formats

- **Format Validation**: Stricter validation at initialization
  - Unsupported formats now raise ValueError immediately
  - Missing dependencies (e.g., PyTorch) detected early

- **Patch Saving Logic**: Refactored for multi-format support
  - Cleaner separation of format-specific logic
  - Base filename generation for consistency across formats
  - Incremental saving per format reduces memory pressure

---

## üì¶ Installation

```bash
# Install from PyPI
pip install ign-lidar-hd==2.2.0

# Or upgrade from previous version
pip install --upgrade ign-lidar-hd
```

For PyTorch format support:

```bash
pip install torch
```

---

## üöÄ Usage Examples

### Multi-Format Processing

```bash
# Save in both HDF5 and LAZ formats
ign-lidar-hd process \
  input_dir=data/tiles \
  output_dir=data/patches \
  output.format=hdf5,laz

# Save all formats for experimentation
ign-lidar-hd process \
  input_dir=data/tiles \
  output_dir=data/patches \
  output.format=npz,hdf5,torch,laz
```

### LAZ Patch Visualization

```bash
# Create LAZ patches for CloudCompare
ign-lidar-hd process \
  input_dir=data/tiles \
  output_dir=data/patches \
  output.format=laz \
  features.add_rgb=true

# Open in CloudCompare
cloudcompare data/patches/*.laz
```

### HDF5 to LAZ Conversion

```bash
# Convert existing HDF5 patches to LAZ
python scripts/convert_hdf5_to_laz.py \
  data/patches \
  data/patches_laz

# Inspect HDF5 structure
python scripts/convert_hdf5_to_laz.py --inspect data/patches/patch_0001.h5
```

### Configuration File

```yaml
# config.yaml
process:
  input_dir: data/tiles
  output: data/patches
  
output:
  format: hdf5,laz  # Multi-format output
  save_enriched_laz: true
  save_metadata: true

features:
  add_rgb: true
  add_infrared: true
```

---

## üîÑ Migration from v2.1.x

### No Breaking Changes

This release is fully backward compatible. Existing code and configurations continue to work.

### Recommended Updates

If you previously used `output.format=hdf5`:

1. **Reinstall package**: `pip install --upgrade ign-lidar-hd`
2. **Rerun processing**: Old HDF5 files were not generated (bug)
3. **Consider multi-format**: Use `output.format=hdf5,laz` for visualization support

### New Features

Take advantage of new capabilities:

```yaml
# Before (v2.1.x)
output:
  format: npz

# After (v2.2.0) - More options!
output:
  format: npz,laz  # Also save LAZ for visualization
```

---

## üìö Documentation

### New Documentation

- **`MULTI_FORMAT_OUTPUT_IMPLEMENTATION.md`** - Technical implementation details
- **`MULTI_FORMAT_QUICK_START.md`** - Quick reference guide
- **`scripts/CONVERT_HDF5_TO_LAZ.md`** - Converter documentation
- **`OUTPUT_FORMAT_ANALYSIS.md`** - Format analysis and recommendations
- **`HDF5_BUG_FIX.md`** - Details of HDF5 bug fix

### Updated Documentation

- **README.md** - Updated to version 2.2.0
- **CHANGELOG.md** - Complete v2.2.0 changelog
- **Website docs** - Updated examples and tutorials

---

## üéØ Use Cases

### 1. Machine Learning Training

```yaml
output:
  format: npz  # Fast, efficient for training
```

### 2. Visualization & QA

```yaml
output:
  format: laz  # Open in CloudCompare
```

### 3. Experimentation

```yaml
output:
  format: npz,hdf5,laz  # All formats for flexibility
```

### 4. Production Pipeline

```yaml
output:
  format: hdf5,laz  # HDF5 for training + LAZ for QA
```

---

## üêõ Known Issues

No known issues at this time. Please report any issues on [GitHub Issues](https://github.com/sducournau/IGN_LIDAR_HD_DATASET/issues).

---

## üìä Performance Impact

Multi-format output has minimal performance impact:

- **Single format**: Same as previous versions
- **Multi-format**: ~10-20% slower (one-time saving overhead)
- **Memory**: No significant increase (incremental saving)

---

## üîó Related Releases

- [v2.1.2](./v2.1.2.md) - Documentation updates
- [v2.1.1](./v2.1.1.md) - Bug fixes
- [v2.1.0](./v2.1.0.md) - Feature validation
- [v2.0.2](./v2.0.2.md) - Stability improvements
- [v2.0.0](./v2.0.0.md) - Major architecture overhaul

---

## üí¨ Support

- **Documentation**: https://sducournau.github.io/IGN_LIDAR_HD_DATASET/
- **Issues**: https://github.com/sducournau/IGN_LIDAR_HD_DATASET/issues
- **PyPI**: https://pypi.org/project/ign-lidar-hd/

---

## üôè Credits

Special thanks to the community for reporting the HDF5 bug and requesting multi-format support!
