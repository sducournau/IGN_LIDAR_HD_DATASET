---
sidebar_position: 1
title: v2.2.1 Release Notes
---

# Release Notes: v2.2.1

**Release Date:** October 10, 2025

## 🔧 Critical Augmentation Fix

Version 2.2.1 addresses a **critical spatial consistency bug** in data augmentation that could significantly impact model training quality.

### The Problem

In versions before v2.2.1, when augmentation was enabled, augmented patches represented **different geographical regions** than their original patches:

```
❌ Before v2.2.1:
urban_dense_patch_0000.npz       # Region A (original)
urban_dense_patch_0000_aug_0.npz # Region B (different area!)
urban_dense_patch_0000_aug_1.npz # Region C (yet another area!)
```

**Root Cause:** The pipeline applied augmentation (rotation, jitter, scaling) to the entire tile before extracting patches. This caused the spatial grid to shift, resulting in patches being extracted from different locations.

### The Solution

v2.2.1 restructures the augmentation pipeline to ensure spatial consistency:

1. **Extract patches once** from the original data (defines spatial locations)
2. **Augment each patch individually** (same region, just transformed)

```
✅ v2.2.1+:
urban_dense_patch_0000.npz       # Region A (original)
urban_dense_patch_0000_aug_0.npz # Region A (augmented)
urban_dense_patch_0000_aug_1.npz # Region A (augmented)
```

Now all versions of a patch represent the **same geographical area**, just with different transformations applied.

## 🆕 What's New

### Fixed

- **Critical Augmentation Bug**: Augmented patches now correctly represent the same spatial regions as their originals
  - Changed from tile-level to patch-level augmentation
  - Maintains spatial consistency across all augmentation versions
  - Fixes label alignment issues after dropout

### Added

- **Enhanced Augmentation Function**: Added `return_mask` parameter to `augment_raw_points()`

  - Returns dropout mask for proper label alignment
  - Supports both old and new calling conventions
  - Type-safe with Union return types

- **Patch Metadata Tracking**: Improved version management

  - `_version`: Tracks patch version (`'original'`, `'aug_0'`, `'aug_1'`, etc.)
  - `_patch_idx`: Links augmented patches to their original patch

- **Verification Tool**: New `scripts/verify_augmentation_fix.py`

  - Validates spatial consistency of augmented patches
  - Computes centroid distances and label distribution similarity
  - Provides detailed reports with pass/warn status

- **Comprehensive Documentation**: New `AUGMENTATION_FIX.md`
  - Explains the problem and solution in detail
  - Provides migration guidance
  - Includes verification examples

### Changed

- **Pipeline Restructure**: Augmentation now happens at patch level
  - Extract patches once from original data
  - Create augmented versions by transforming each patch
  - More efficient and spatially consistent

## ⚠️ Breaking Changes & Migration

### Action Required

**Datasets with augmentation created before v2.2.1 should be regenerated** to ensure spatial consistency.

Old augmented patches may have mixed different geographical regions, which could negatively impact model training and evaluation.

### How to Regenerate

```bash
# Install updated version
pip install --upgrade ign-lidar-hd

# Regenerate patches with augmentation
python -m ign_lidar.cli.generate_dataset \
    --input /path/to/laz/files \
    --output /path/to/new/patches \
    --augment \
    --num-augmentations 3
```

### Verification

Verify the fix with the included tool:

```bash
python scripts/verify_augmentation_fix.py \
    /path/to/new/patches \
    --max-patches 5
```

Expected output:

```
✅ All checks passed! Augmented patches represent same spatial regions.
```

## 📊 Impact Assessment

### Who Should Regenerate?

You should regenerate your dataset if:

- ✅ You used augmentation (`--augment` or `augment=true`)
- ✅ You're training models on augmented data
- ✅ You're evaluating model performance across augmentation versions
- ✅ You need spatial consistency for validation or visualization

You can skip regeneration if:

- ❌ You never used augmentation
- ❌ You're only using original patches (no `_aug_*` files)
- ❌ Your models are already trained and you're not retraining

### Benefits of Regeneration

1. **Better Training**: Models learn true augmentation invariance
2. **Consistent Validation**: Compare original vs augmented patches fairly
3. **Debugging**: Visualize before/after augmentation effects
4. **Reproducibility**: Patch indices have consistent meaning

## 🔍 Technical Details

### Augmentation Transformations

Applied per patch (not per tile):

1. **Rotation**: Random Z-axis rotation (0-360°)
2. **Jitter**: Gaussian noise σ=0.1m
3. **Scaling**: Uniform (0.95-1.05)
4. **Dropout**: Random (5-15% points removed)

### Label Alignment

The `return_mask` parameter ensures labels stay aligned with points after dropout:

```python
(aug_points, aug_intensity, aug_return, _,
 aug_rgb, _, _, keep_mask) = augment_raw_points(
    patch_points,
    patch_intensity,
    patch_return_num,
    patch_classification,
    rgb=patch_rgb,
    return_mask=True  # Get dropout mask
)

# Apply same mask to labels
aug_labels = original_labels[keep_mask]
```

## 📚 Related Documentation

- [AUGMENTATION_FIX.md](https://github.com/sducournau/IGN_LIDAR_HD_DATASET/blob/main/AUGMENTATION_FIX.md) - Complete explanation
- [Data Augmentation Guide](/guides/data-augmentation) - Usage guide
- [API Reference](/api/preprocessing) - Technical details

## 🙏 Acknowledgments

Thanks to users who reported unexpected behavior with augmented patches, helping us identify and fix this critical issue.

## 📦 Installation

Update to v2.2.1:

```bash
pip install --upgrade ign-lidar-hd
```

Or with conda:

```bash
conda install -c conda-forge ign-lidar-hd
```

## 🔗 Links

- [GitHub Repository](https://github.com/sducournau/IGN_LIDAR_HD_DATASET)
- [PyPI Package](https://pypi.org/project/ign-lidar-hd/)
- [Full Changelog](https://github.com/sducournau/IGN_LIDAR_HD_DATASET/blob/main/CHANGELOG.md)
- [Migration Guide](/guides/migration-v1-to-v2)
